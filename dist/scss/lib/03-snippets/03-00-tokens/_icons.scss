///
/// @package @maddimathon/design-system-utilities@0.1.0-alpha.3
/// @since 0.1.0-alpha
///

@use 'pkg:@maddimathon/utility-sass/feature-check';
@use 'pkg:@maddimathon/utility-sass/list';
@use 'pkg:@maddimathon/utility-sass/map';
@use 'pkg:@maddimathon/utility-sass/selector';
@use 'pkg:@maddimathon/utility-sass/string';

// @use 'pkg:@maddimathon/utility-astro/03-snippets' as lib;

// @use '../../../config';
@use '../../../tokens';

@use '../../01-functions' as *;
@use '../../02-mixins' as *;

$_allUniqueIconAspectRatios: ();

@each $slug, $map in tokens.$icons {
    $_ratio: map.get($map, aspectRatio);

    $_ratioSlug: string.slugify(#{$_ratio});

    @if not map.has-key($_allUniqueIconAspectRatios, $_ratioSlug) {
        //
        $_ratioList: aspect-ratio-string-to-list($_ratio);

        $_allUniqueIconAspectRatios: map.set(
            $_allUniqueIconAspectRatios,
            $_ratioSlug,
            (
                ratio: $_ratio,
                width: list.nth($_ratioList, 1),
                height: list.nth($_ratioList, 2),
            )
        );
    }
}

///
/// Adds support for icons, assuming the html matches that in the local astro
/// Icon component.
///
/// @since 0.1.0-alpha
///
@mixin snippet-support-icons {
    %icon {
        display: inline-block;
        position: relative;
        vertical-align: #{var-token(icon-vertical-align, $fallback: middle)};

        height: #{var-token(icon-size)};
        height: calc(
            #{var-token(icon-size)} * var(--icon-size--font-multiplier, 1)
        );

        color: #{var-token(icon-color)};

        > svg {
        }
    }

    @each $slug, $map in $_allUniqueIconAspectRatios {
        %icon-aspect-ratio--#{$slug} {
            @include aspect-ratio(map.get($map, width), map.get($map, height));
        }
    }

    @each $slug, $map in tokens.$icons {
        %icon {
            &--#{$slug} {
                $aspectRatio: icon-aspect-ratio-value($slug);
                @extend %icon-aspect-ratio--#{string.slugify( #{$aspectRatio} )};
            }
        }
    }
}

///
/// Adds properties for displaying an icon inside a ::before or ::after selector.
///
/// @since 0.1.0-alpha
///
@mixin snippet-icon-pseudo-element($slug, $pseudo: 'after') {
    $_start: if($pseudo == before, end, start);
    $_end: if($pseudo == before, start, end);

    @supports (mask-image: url('../fake.svg')) {
        display: inline-block;
        vertical-align: #{var-token(icon-vertical-align, $fallback: sub)};

        content: '';
        content: '' / #{icon-label-value($slug)};

        background: #{var-token(icon-color)};

        mask-image: #{icon-embedded-value($slug)};
        mask-clip: no-clip;
        mask-mode: alpha;
        mask-origin: border-box;
        mask-position: center;
        mask-repeat: no-repeat;
        mask-size: contain;

        margin-block-start: var(--icon-pseudo-element-margin-block-start, 0);
        margin-inline-#{$_start}: #{var-token(icon-inline-buffer)};
        margin-inline-#{$_start}: calc(
            #{var-token(icon-inline-buffer)} *
                var(
                    --icon-size-pseudo--inline-buffer-start,
                    var(--icon-size-pseudo--font-multiplier, 1)
                )
        );
        margin-inline-#{$_end}: calc(
            #{var-token(icon-inline-buffer)} *
                var(--icon-size-pseudo--inline-buffer-end, 0)
        );

        height: #{var-token(icon-size-pseudo)};
        height: calc(
            #{var-token(icon-size-pseudo)} *
                var(--icon-size-pseudo--font-multiplier, 1)
        );

        $aspectRatioMap: aspect-ratio-string-to-list(
            icon-aspect-ratio-value($slug)
        );
        @include aspect-ratio(
            list.nth($aspectRatioMap, 1),
            list.nth($aspectRatioMap, 2)
        );

        & {
            @content;
        }
    }
}

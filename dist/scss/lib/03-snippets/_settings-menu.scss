///
/// @package @maddimathon/design-system-utilities@0.1.0-alpha.6
/// @since 0.1.0-alpha
///
@use 'pkg:@maddimathon/utility-sass/feature-check';
@use 'pkg:@maddimathon/utility-sass/map';
@use 'pkg:@maddimathon/utility-sass/math';
@use 'pkg:@maddimathon/utility-sass/meta';

@use '../../config';
@use '../../tokens';

@use '../01-functions' as *;
@use '../02-mixins' as *;

@use 'pkg:@maddimathon/utility-astro/03-snippets' as utils;

$_closing_time: var-tr-time(toggle-closing);

///
/// Supports the SettingsMenu astro component.
///
/// @since 0.1.0-alpha
///
@mixin snippet-support-astro-settings-menu {
    @include utils.snippet-support-astro-settings-menu;

    %aside {
        font-style: normal;
        font-size: #{var-fs(smaller-1)};

        em {
            font-style: italic;

            em {
                font-style: normal;

                em {
                    font-style: italic;
                }
            }
        }
    }

    .website-settings-menu {
        @include no-motion {
            @include cx-prop(toggle-closing-time, var-tr-time(normal));
        }
    }

    .website-settings__content {
        fieldset {
            transition: var(--#{config.$cxPropPre}transition);

            > legend {
                color: #{var-theme(text-primary)};
            }
        }
    }

    .website-settings__disclaimer {
    }

    [data-toggle-control-backdrop] {
        transition: var(--#{config.$cxPropPre}transition);
    }

    /* With Javascript ==================================== */

    [data-toggle-control] {
        .website-settings-menu &,
        .website-settings-menu[data-toggle-container='open'] & {
            border-radius: #{var-style(button-border-radius)};

            @include hover-focus-visible(
                $addSelectors: (
                    '&:active',
                )
            ) {
                color: #{var-theme(button-primary-text-hover)};
            }
        }
    }

    @include feature-check.js {
        .website-settings-menu {
            [data-toggle-control] {
                @include cx-prop(icon-color, currentColor);
            }

            > [data-toggle-content] {
                border-radius: #{var-style(button-border-radius)};
            }

            &[data-toggle-container='open'] {
                [data-toggle-control-backdrop] {
                    opacity: 0;
                    animation: fade-in #{var-tr-time(normal)} ease-in-out 10ms
                        forwards;
                }
            }

            &[data-toggle-container='closing'] {
                [data-toggle-control-backdrop] {
                    opacity: 0;
                    animation: fade-out #{var-tr-time(normal)} ease-in-out 0ms
                        forwards;
                }
            }
        }
    }
}

///
/// Supports font override settings (according to the tokens).
///
/// @since 0.1.0-alpha
///
@mixin snippet-support-astro-settings-menu-font-overrides {
    @each $map in map.get(tokens.$designSystem, font, familyOverrides) {
        //
        $label: map.get($map, label);
        $slug: map.get($map, value);

        $attrSelector: '[data-font-family-override=#{$slug}]';

        $selectors: $attrSelector;

        @if map.has-key($map, labelClass) {
            $selectors: '#{$selectors}, #{$attrSelector} *, .website-settings-menu .#{map.get($map, labelClass)}';
        }

        @at-root #{$selectors} {
            font-family: #{var-font-family($slug)} !important;
        }

        @at-root #{$attrSelector} {
            //
            @if $label == 'Open Dyslexic' {
                @include cx-prop(icon-size--font-multiplier, 1.1875);
                @include cx-prop(icon-size-pseudo--font-multiplier, 1.25);
                @include cx-prop(icon-size-pseudo--inline-buffer-start, 3);
                @include cx-prop(icon-size-pseudo--inline-buffer-end, 1);
            }

            $_multi_width: map.get($map, contentWidthScale);

            @if $_multi_width != null {
                //

                @if meta.type-of($_multi_width) == number and $_multi_width != 1
                {
                    $_multi_border: -1;

                    @if $_multi_width > 1 {
                        $_multi_border: $_multi_width;
                    }

                    // WIDTHS
                    @if $_multi_width > 0 and $_multi_width != 1 {
                        //
                        @each $slug, $_value in config.$widths {
                            @each $value
                                in width-value(
                                    $slug,
                                    $returnAsNumber: false,
                                    $multiplier: $_multi_width
                                )
                            {
                                @include cx-prop(width-#{$slug}, $value);
                            }
                        }
                    }

                    // BORDER WIDTHS
                    @if $_multi_border > 0 and $_multi_border != 1 {
                        //
                        @each $slug, $_value in tokens.$border_widths {
                            $_oldValue: border-width-value($slug);

                            $_newValue: math.round-to-pixel(
                                $_oldValue * $_multi_border,
                                32
                            );

                            @if $_newValue != $_oldValue {
                                @include cx-prop(
                                    border-width-#{$slug},
                                    $_newValue
                                );
                            }
                        }
                    }
                }
            }

            $_multi_lh: map.get($map, lineHeightScale);

            @if $_multi_lh != null {
                //
                @if meta.type-of($_multi_lh) == number and $_multi_lh != 1 {
                    $_multi_margin: -1;
                    $_multi_stroke: -1;

                    @if $_multi_lh > 1 {
                        $_multi_margin: if(
                            $_multi_lh < 2,
                            calc(
                                (($_multi_lh - 1) * mrg-value-firm('400')) + 1
                            ),
                            $_multi_lh
                        );

                        $_multi_stroke: $_multi_lh;
                    }

                    // MARGINS
                    @if $_multi_margin >
                        0 and
                        ($_multi_margin < 1 or $_multi_margin >= 1.0625)
                    {
                        //
                        @each $level, $_value in tokens.$margins {
                            @include cx-prop(
                                mrg-firm-#{$level},
                                #{math.round-to-pixel(
                                        mrg-value-firm($level) * $_multi_margin
                                    )}rem
                            );
                        }
                        @each $level, $_value in tokens.$margins {
                            @include cx-prop(
                                mrg-soft-#{$level},
                                #{math.round-to-pixel(
                                        mrg-value-soft($level) * $_multi_margin
                                    )}rem
                            );
                        }
                        @each $level, $_value in tokens.$margins {
                            @include cx-prop(
                                mrg-half-#{$level},
                                #{math.round-to-pixel(
                                        mrg-value-half($level) * $_multi_margin
                                    )}rem
                            );
                        }
                    }

                    // LINE HEIGHTS
                    @each $slug, $_value in tokens.$line_heights {
                        $_oldValue: line-height-value($slug);

                        $_newValue: math.round-to-pixel(
                            $_oldValue * $_multi_lh,
                            32
                        );

                        @if $_newValue != $_oldValue {
                            @include cx-prop(line-height-#{$slug}, $_newValue);
                        }
                    }

                    // STROKE RELATIVE
                    @if $_multi_stroke > 0 and $_multi_stroke != 1 {
                        @each $slug, $_value in tokens.$strokes_relative {
                            $_oldValue: stroke-relative-value($slug);

                            $_newValue: math.round-to-pixel(
                                $_oldValue * $_multi_stroke,
                                32
                            );

                            @if $_newValue != $_oldValue {
                                @include cx-prop(
                                    stroke-relative-#{$slug},
                                    $_newValue
                                );
                            }
                        }
                    }
                }
            }
        }
    }

    @at-root .website-settings-menu .font-family-override-default {
        font-family: #{var-font-family(body)} !important;
    }
}

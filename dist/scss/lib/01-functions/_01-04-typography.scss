///
/// @package @maddimathon/design-system-utilities@0.1.0-alpha.draft
/// @since 0.1.0-alpha.draft
///

@use 'pkg:@maddimathon/utility-sass/list';
@use 'pkg:@maddimathon/utility-sass/map';
@use 'pkg:@maddimathon/utility-sass/meta';
@use 'pkg:@maddimathon/utility-sass/string';

@use '../../config';
@use '../../tokens';

@use 'pkg:@maddimathon/utility-astro/01-functions' as utils;

$_designSystemHasFontFamilies: map.has-key(tokens.$designSystem, font, family)
    and list.length(map.keys(map.get(tokens.$designSystem, font, family))) > 0;

@function tokens-has-font-families() {
    @return $_designSystemHasFontFamilies;
}

///
/// @since 0.1.0-alpha.draft
///
@function font-family-exists($slug) {
    // returns
    @if not map.has-key(tokens.$designSystem, font, family) {
        @return false;
    }

    @return map.has-key(tokens.$designSystem, font, family, $slug);
}

///
/// @since 0.1.0-alpha.draft
///
@function font-family-list($slug) {
    // returns
    @if not map.has-key(tokens.$designSystem, font, family) {
        @warn 'there are no font family tokens';
        @return utils.font-family-system-ui();
    }

    // returns
    @if not map.has-key(tokens.$designSystem, font, family, $slug) {
        @warn "$slug '#{$slug}' was not a key in the font family tokens";
        @return utils.font-family-system-ui();
    }

    $fontMap: map.get(
        tokens.$designSystem,
        font,
        family,
        $slug,
        weights,
        '400',
        normal
    );

    @return utils.font-list(
        list.join(
            (map.get($fontMap, family)),
            map.get($fontMap, fallbacks),
            $separator: comma
        )
    );
}

///
/// @since 0.1.0-alpha.draft
///
@function var-font-family($slug) {
    @return if(
        config.$fn_var_replaceWithValue_fontFamily,
        font-family-list($slug),
        var(--ff-#{$slug}, font-family-list($slug))
    );
}

///
/// @since 0.1.0-alpha.draft
///
@function var-fs($slug, $fallback: null) {
    // returns
    @if config.$fn_var_replaceWithValue_fontSize {
        @return if(
            $fallback == null,
            list.nth(utils.fs-value($slug), 1),
            $fallback
        );
    }

    @return utils.var-fs($slug, $fallback: $fallback);
}

$_flattenedStyles: map.flatten(map.get(tokens.$designSystem, style));

///
/// Uses the (flattened) style tokens.
///
/// @since 0.1.0-alpha.draft
///
@function style-value($slug) {
    // returns
    @if not map.has-key($_flattenedStyles, $slug) {
        @warn "$slug '#{$slug}' was not a key in flattened tokens.$designSystem.style";
        @return $slug;
    }

    $value: map.get($_flattenedStyles, $slug);

    $isLineHeight: false;
    $isMargin: false;

    @if string.index($slug, heading-) == 1 {
        $_slugLength: string.length($slug);

        // margins
        @if string.index($slug, -margin-) {
            $isMargin: true;
        } @else if string.index($slug, '-margin') == ($_slugLength - 6) {
            $isMargin: true;
        }

        // line-height
        @if string.index($slug, '-line-height') == ($_slugLength - 11) {
            $isLineHeight: true;
        }
    }

    @if $isMargin {
        @if string.index($slug, margin-block-start) {
            $value: utils.var-mrg-soft($value);
        } @else if string.index($slug, margin-block-end) {
            $value: utils.var-mrg-half($value);
        } @else {
            $value: utils.var-mrg-firm($value);
        }
    } @else if $isLineHeight {
        $value: utils.var-line-height($value);
    }

    @return $value;
}

///
/// @since 0.1.0-alpha.draft
///
@function var-style($slug) {
    @return if(
        config.$fn_var_replaceWithValue_style,
        style-value($slug),
        var(--style-#{$slug}, #{style-value($slug)})
    );
}

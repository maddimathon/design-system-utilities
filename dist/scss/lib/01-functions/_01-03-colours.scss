///
/// @package @maddimathon/design-system-utilities@0.1.0-alpha.draft
/// @since 0.1.0-alpha.draft
///

@use 'pkg:@maddimathon/utility-sass/colour';
@use 'pkg:@maddimathon/utility-sass/list';
@use 'pkg:@maddimathon/utility-sass/map';
@use 'pkg:@maddimathon/utility-sass/meta';
@use 'pkg:@maddimathon/utility-sass/string';

@use '../../config';
@use '../../tokens';

@use 'utils';

$_activeTheme: map.get(tokens.$themes, tokens.$activeTheme);

$_systemColors: map.merge(
    $defaults: map.flatten(utils.get-sys-colours()),
    $inputs: map.flatten(map.get($_activeTheme, forced-colors, system)),
    $recursive: true,
);

///
/// @since 0.1.0-alpha.draft
///
@function get-sys-colours() {
    @return $_systemColors;
}

///
/// Returns the appropriate var (with fallback).
///
/// @since 0.1.0-alpha.draft
///
@function var-clr($slug, $level, $brightness: tokens.$brightnessMode_default) {
    // returns
    @if not map.has-key(tokens.$colour, '#{$slug}') {
        @warn "$slug '#{$slug}' was not a key in tokens.$colour";
        @return var(--clr-#{$slug}-#{$level});
    }

    $slugMap: map.get(tokens.$colour, $slug);

    // returns
    @if meta.type-of($slugMap) != map or not map.has-key($slugMap, '#{$level}')
    {
        @warn "$level '#{$level}' was not a key in tokens.$colour.#{$slug}";
        @return var(--clr-#{$slug}-#{$level});
    }

    $dark_level: $level;

    @if $brightness == dark {
        $dark_level: colour.shade-map-reverse-key(
            $level,
            $slugMap,
            $sort: true
        );
    }

    @return var(
        --clr-#{$slug}-#{$level},
        #{colour.to-hsl(
                map.get(
                    $slugMap,
                    if($brightness == dark, '#{$dark_level}', '#{$level}')
                ),
                $round: false
            )}
    );
}

/// THEME
/// ======================================================================== ///

$_activeTheme: map.get(tokens.$themes, tokens.$activeTheme);
$_flattenedActiveTheme: map.flatten($_activeTheme);

///
/// Gets the colour value (either system or var-clr) for the given token slug.
///
/// @since 0.1.0-alpha.draft
///
@function var-clr-from-theme-token(
    $tokenValue,
    $brightness: tokens.$brightnessMode_default
) {
    // returns
    @if string.length(#{$tokenValue}) > 0 and string.index(#{$tokenValue}, '-')
    {
        @return var-clr(
            string.slice(#{$tokenValue}, 1, -5),
            string.slice(#{$tokenValue}, -3, -1),
            $brightness: $brightness
        );
    }

    @return #{$tokenValue};
}

///
/// Gets the value for the given token slug.
///
/// @since 0.1.0-alpha.draft
///
@function theme-token-value($slug, $brightness, $contrast) {
    // returns
    @if $contrast == forced-colors {
        @if not map.has-key($_flattenedActiveTheme, '#{$contrast}-#{$slug}') {
            @warn "$slug '#{$slug}' was not a key in flattened tokens.$themes for the $activeTheme '#{tokens.$activeTheme}'";
            @return ();
        }

        @return map.get($_flattenedActiveTheme, '#{$contrast}-#{$slug}');
    }

    // returns - no fallback
    @if not map.has-key($_activeTheme, $brightness) {
        @warn "$brightness '#{$brightness}' was not a key in tokens.$themes for the $activeTheme '#{tokens.$activeTheme}'";
        @return ();
    }

    // returns - no fallback
    @if not map.has-key(map.get($_activeTheme, $brightness), $contrast) {
        @warn "$contrast '#{$contrast}' was not a key in tokens.$themes.#{$brightness} for the $activeTheme '#{tokens.$activeTheme}'";
        @return ();
    }

    // returns - no fallback
    @if not
        map.has-key(
            $_flattenedActiveTheme,
            '#{$brightness}-#{$contrast}-#{$slug}'
        )
    {
        @warn "$slug '#{$slug}' was not a key in flattened tokens.$themes.#{$brightness}.#{$contrast} for the $activeTheme '#{tokens.$activeTheme}'";
        @return ();
    }

    @return map.get(
        $_flattenedActiveTheme,
        '#{$brightness}-#{$contrast}-#{$slug}'
    );
}

///
/// Returns the appropriate var (with fallback).
///
/// @since 0.1.0-alpha.draft
///
@function var-theme(
    $slug,
    $brightness: tokens.$brightnessMode_default,
    $contrast: tokens.$contrastMode_default
) {
    $clrSlug: theme-token-value($slug, $brightness, $contrast);

    // returns
    @if list.length($clrSlug) < 1 {
        @return var(--theme-#{$slug});
    }

    // returns
    @if $contrast == forced-colors {
        @return $clrSlug;
    }

    @return var(
        --theme-#{$slug},
        var-clr-from-theme-token($clrSlug, $brightness: $brightness)
    );
}

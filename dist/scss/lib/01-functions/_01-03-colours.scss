///
/// @package @maddimathon/design-system-utilities@0.1.0-alpha.4
/// @since 0.1.0-alpha
///

@use 'pkg:@maddimathon/utility-sass/colour';
@use 'pkg:@maddimathon/utility-sass/list';
@use 'pkg:@maddimathon/utility-sass/map';
@use 'pkg:@maddimathon/utility-sass/meta';
@use 'pkg:@maddimathon/utility-sass/string';

@use '../../config';
@use '../../tokens';

@use 'pkg:@maddimathon/utility-astro/01-functions' as utils;

$_activeTheme: map.get(tokens.$themes, tokens.$activeTheme);

$_systemColors: map.merge(
    $defaults: map.flatten(utils.get-sys-colours()),
    $inputs: map.flatten(map.get($_activeTheme, forced-colors, system)),
    $recursive: false,
);

///
/// @since 0.1.0-alpha
///
@function get-sys-colours() {
    @return $_systemColors;
}

///
/// Returns the appropriate var (with fallback).
///
/// @since 0.1.0-alpha
///
@function var-clr($slug, $level, $brightness: tokens.$brightnessMode_default) {
    $slugMap: map.get(tokens.$colour, $slug);

    // returns
    @if $slugMap == null {
        @warn "$slug '#{$slug}' was not a key in tokens.$colour";
        @return var(--clr-#{$slug}-#{$level});
    }

    // returns
    @if meta.type-of($slugMap) != map {
        @warn "$level '#{$level}' was not a key in tokens.$colour.#{$slug}";
        @return var(--clr-#{$slug}-#{$level});
    }

    $level_brightnessAdjusted: $level;

    @if $brightness == dark {
        $level_brightnessAdjusted: colour.shade-map-reverse-key(
            $level,
            $slugMap,
            $sort: true
        );
    }

    $fallback_clr: map.get($slugMap, $level_brightnessAdjusted);

    // returns
    @if $fallback_clr == null {
        @warn "$level '#{$level}' was not a key in tokens.$colour.#{$slug}";
        @return var(--clr-#{$slug}-#{$level});
    }

    $fallback: colour.to-hsl(
        map.get($slugMap, $level_brightnessAdjusted),
        $round: false
    );

    @return if(
        config.$fn_var_replaceWithValue_colour,
        $fallback,
        var(--clr-#{$slug}-#{$level}, #{$fallback})
    );
}

/// THEME
/// ======================================================================== ///

///
/// Gets the colour value (either system or var-clr) for the given token slug.
///
/// @since 0.1.0-alpha
///
@function var-clr-from-theme-token(
    $tokenValue,
    $brightness: tokens.$brightnessMode_default
) {
    // returns
    @if string.length(#{$tokenValue}) > 0 and string.index(#{$tokenValue}, '-')
    {
        @return var-clr(
            string.slice(#{$tokenValue}, 1, -5),
            string.slice(#{$tokenValue}, -3, -1),
            $brightness: $brightness
        );
    }

    @return $tokenValue;
}

///
/// Gets the value for the given token slug.
///
/// @since 0.1.0-alpha
///
@function theme-token-value(
    $slug,
    $brightness,
    $contrast,
    $themeSlug: tokens.$activeTheme
) {
    $activeTheme_flat: map.get(tokens.$themes__nestedFlat, $themeSlug);

    @if $activeTheme_flat == null {
        @warn "$themeSlug '#{$themeSlug}' was not a key in tokens.$themes__nestedFlat";
        $themeSlug: default;
        $activeTheme_flat: map.get(tokens.$themes__nestedFlat, $themeSlug);
    }

    // returns
    @if $contrast == forced-colors {
        $value: map.get($activeTheme_flat, $contrast, $slug);

        @if $value == null {
            @warn "$slug '#{$slug}' was not a key in tokens.$themes__nestedFlat.#{$themeSlug}.#{$contrast}";
            @return ();
        }

        @return $value;
    }

    $value: map.get($activeTheme_flat, $brightness, $contrast, $slug);

    // returns - no fallback
    @if $value == null {
        @warn "$slug '#{$slug}' was not a key in tokens.$themes__nestedFlat.#{$themeSlug}.#{$brightness}.#{$contrast}";
        @return ();
    }

    @return $value;
}

///
/// Returns the appropriate var (with fallback).
///
/// @since 0.1.0-alpha
///
@function var-theme(
    $slug,
    $brightness: tokens.$brightnessMode_default,
    $contrast: tokens.$contrastMode_default,
    $themeSlug: tokens.$activeTheme
) {
    $clrSlug: theme-token-value(
        $slug,
        $brightness: $brightness,
        $contrast: $contrast,
        $themeSlug: $themeSlug
    );

    // returns
    @if list.length($clrSlug) < 1 {
        @return var(--theme-#{$slug});
    }

    // returns
    @if $contrast == forced-colors {
        @return $clrSlug;
    }

    @return var(
        --theme-#{$slug},
        var-clr-from-theme-token($clrSlug, $brightness: $brightness)
    );
}

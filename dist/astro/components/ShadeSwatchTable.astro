---
/**
 * @since 0.1.0-alpha
 *
 * @packageDocumentation
 */

/* import - types */
import Heading from '@maddimathon/utility-astro/components/Heading';
import type { ColourLevels, ColourLevels_Extended } from '../../ts/02-tokens/@types.d.ts';
import type { Tokens, Tokens_Internal } from '../../ts/02-tokens/Tokens.js';
import type { Tokens_Colour } from '../../ts/02-tokens/Tokens_Colour.js';

/* import - functions */
import { ColourUtilities } from '../../ts/01-utilities/ColourUtilities.js';
import { objectMap } from '../../ts/01-utilities/objectMap.js';
import { colourToArray } from '../functions/colourToArray.js';
import { textColorLevel } from './ShadeSwatch.astro';
 
/* import - values */
 
/* import - components */
import ShadeSwatch from './ShadeSwatch.astro';
import ContrastAlert from './ContrastAlert.astro';
import { arrayUnique } from '@maddimathon/utility-typescript/functions';

/* import - layouts */

/* PROPS ===================================== */

export interface Props<
    T_ColourName extends string = Tokens_Internal.Default_ColourName,
    T_ExtraLevels extends ColourLevels_Extended = Tokens_Internal.Default_ExtraColourLevels,
> {
    colour: Tokens_Colour.JsonReturn<T_ColourName, T_ExtraLevels>;
    id: string; 
    heading: number;
    tokens: Tokens.JsonReturn;

    excludeLevels?: ( ColourLevels | T_ExtraLevels )[];
    
    /**
     * Whether to include the given colour formats by default.
     *
     * @since 0.1.0-alpha.4
     */
    includeColourFormats?: {
        hex?: boolean;
        hsl?: boolean;
        lch?: boolean;
        rgb?: boolean;
    };

    /**
     * Whether to include the contrast targets as column headers.
     *
     * @since 0.1.0-alpha.4
     */
    includeTargetLevels?: boolean;

    targets?: undefined|LevelTargets|{
        base: undefined|LevelTargets;
        accent?: undefined|LevelTargets;
    };

    frontmatter?: Omit<Props<T_ColourName, T_ExtraLevels>, 'frontmatter'>;
};

const {
    excludeLevels = [],
    heading,
    id,
    includeTargetLevels = import.meta.env.DEV,
    includeColourFormats = {},
    targets: _targets,
    tokens,
    ...props
}: Props = Astro.props.frontmatter ?? Astro.props;

/* TYPES ===================================== */

export type LevelTargets = {
    [ L in ColourLevels | ColourLevels_Extended ]: {
        min: {
            aa: {
                ui: ColourLevels | ColourLevels_Extended | undefined,
                text: ColourLevels | ColourLevels_Extended | undefined,
            },
            aaa: {
                ui: ColourLevels | ColourLevels_Extended | undefined,
                text: ColourLevels | ColourLevels_Extended | undefined,
            },
        },
        max: ColourLevels | ColourLevels_Extended | undefined,
    }
};

export const DEFAULT_LEVEL_TARGETS: LevelTargets = {
    '100': {
        min: {
            aa: {
                ui: '500',
                text: '600',
            },
            aaa: {
                ui: '600',
                text: '700',
            },
        },
        max: '900',
    },

    '150': {
        min: {
            aa: {
                ui: '500',
                text: '600',
            },
            aaa: {
                ui: '600',
                text: '700',
            },
        },
        max: '900',
    },

    '200': {
        min: {
            aa: {
                ui: '500',
                text: '600',
            },
            aaa: {
                ui: '600',
                text: '700',
            },
        },
        max: '900',
    },

    '250': {
        min: {
            aa: {
                ui: '600',
                text: '700',
            },
            aaa: {
                ui: '700',
                text: '750',
            },
        },
        max: '900',
    },

    '300': {
        min: {
            aa: {
                ui: '600',
                text: '700',
            },
            aaa: {
                ui: '700',
                text: '800',
            },
        },
        max: '900',
    },

    '350': {
        min: {
            aa: {
                ui: '650',
                text: '750',
            },
            aaa: {
                ui: '750',
                text: '850',
            },
        },
        max: '900',
    },

    '400': {
        min: {
            aa: {
                ui: '700',
                text: '800',
            },
            aaa: {
                ui: '800',
                text: undefined,
            },
        },
        max: '900',
    },

    '450': {
        min: {
            aa: {
                ui: '100',
                text: '850',
            },
            aaa: {
                ui: '850',
                text: undefined,
            },
        },
        max: '900',
    },

    '500': {
        min: {
            aa: {
                ui: '200',
                text: undefined,
            },
            aaa: {
                ui: undefined,
                text: undefined,
            },
        },
        max: '900',
    },

    '550': {
        min: {
            aa: {
                ui: '850',
                text: '150',
            },
            aaa: {
                ui: '150',
                text: undefined,
            },
        },
        max: '100',
    },

    '600': {
        min: {
            aa: {
                ui: '300',
                text: '200',
            },
            aaa: {
                ui: '200',
                text: undefined,
            },
        },
        max: '100',
    },

    '650': {
        min: {
            aa: {
                ui: '350',
                text: '250',
            },
            aaa: {
                ui: '250',
                text: '150',
            },
        },
        max: '100',
    },

    '700': {
        min: {
            aa: {
                ui: '400',
                text: '300',
            },
            aaa: {
                ui: '300',
                text: '200',
            },
        },
        max: '100',
    },

    '750': {
        min: {
            aa: {
                ui: '400',
                text: '300',
            },
            aaa: {
                ui: '300',
                text: '250',
            },
        },
        max: '100',
    },

    '800': {
        min: {
            aa: {
                ui: '500',
                text: '400',
            },
            aaa: {
                ui: '400',
                text: '300',
            },
        },
        max: '100',
    },

    '850': {
        min: {
            aa: {
                ui: '500',
                text: '400',
            },
            aaa: {
                ui: '400',
                text: '300',
            },
        },
        max: '100',
    },

    '900': {
        min: {
            aa: {
                ui: '500',
                text: '400',
            },
            aaa: {
                ui: '400',
                text: '300',
            }, 
        },
        max: '100',
    },
};

/* FUNCTIONS ===================================== */

/* CONSTANTS ===================================== */

const includeFormats = {
    hex: true,
    hsl: import.meta.env.DEV ? true : false,
    lch: import.meta.env.DEV ? true : false,
    rgb: false,
    ...includeColourFormats,
};

const allTokenLevels = arrayUnique(Object.values(tokens.colour).map(val=>Object.keys(val) as (keyof typeof val)[]).flat());

const colour = colourToArray(props);

const primaryColour = tokens.colour[
    Object.keys(tokens.colour).filter( k =>  k.match(/^base(\-|\_|$)/i) === null )[0] as keyof typeof tokens.colour
] ?? tokens.colour.base;

const targets: {
    base: LevelTargets;
    accent?: undefined|LevelTargets;
} = _targets ? ('base' in _targets ) ? (_targets.base ? _targets as {
    base:  LevelTargets;
    accent?: undefined | LevelTargets;
} : {base: DEFAULT_LEVEL_TARGETS}) : {base: _targets}  : {base: DEFAULT_LEVEL_TARGETS};

const goalLevels = objectMap(
    targets,
    ([version, levelMap]) => {
        version;

        return levelMap && objectMap(
            levelMap,
            ( [
                targetLevel, 
                value,
            ] ): false | {
                level: ColourLevels|ColourLevels_Extended,
                textLevel: ColourLevels|ColourLevels_Extended,
                min: {
                    aa: {
                        colCount: number;
                        ui: ColourLevels|ColourLevels_Extended | undefined,
                        text: ColourLevels|ColourLevels_Extended | undefined,
                    },
                    aaa: {
                        colCount: number;
                        ui: ColourLevels|ColourLevels_Extended | undefined,
                        text: ColourLevels|ColourLevels_Extended | undefined,
                    },
                },
                max: ColourLevels|ColourLevels_Extended | undefined,
            } => {
                // returns - don't include
                if ( excludeLevels.includes( targetLevel ) || ! allTokenLevels.includes(targetLevel) ) {
                    return false;
                }
                
                return {
                    level: targetLevel,
                    
                    textLevel: value.min.aaa.text
                        ?? value.min.aa.text
                        ?? value.max
                        ?? textColorLevel( targetLevel ),
                    
                    min: objectMap(
                        value.min,
                        ( [ key, minSet ] ) => {
                            key;
                            
                            return {
                                colCount: Object.values( minSet ).filter( v => v).length,
                                ...minSet,
                            };
                        }
                    ),

                    max: value.max,
                };
            }
        )
    }
);
---

{
    colour && (
        <label
            class='site-width | shade-swatch-table__display-control__label'
            aria-ignore="true"
        ><input 
            type="checkbox"
            data-shade-swatch-table-display-text-toggle={id}
        /> Display table without text</label>
        
        <div
            class:list={['table-wrapper | site-width | shade-swatch-table__wrapper']}
        >
            <table id={id}>
                { includeTargetLevels && goalLevels.base && <tr>
                    <th
                        class="screen-reader-text"
                        set:text='contrast targets'
                    />
                    <Fragment>{ (
                        Object.entries( goalLevels.base ) as [ColourLevels|ColourLevels_Extended, typeof goalLevels.base[ColourLevels|ColourLevels_Extended]][]
                    ).map( ([level, set]) => set && <th>
                        <article
                            class:list={['container', 'shade-swatch']}
                            data-brightness-mode={ Number(set.level) <= 500 ? 'light' : 'dark' }
                            data-shade-swatch-has-background={true}
                            style={ [ 
                                `--shade-swatch-background: ${ColourUtilities.toString.hsl(props.colour.base[ set.level ])}`,
                                `--shade-swatch-color: ${ColourUtilities.toString.hsl(props.colour.base[ set.textLevel ])}`,
                             ].join(';') }
                        >
                            <Heading
                                class:list='shade-swatch__name' 
                                displayHeading={7}
                                heading={heading}
                                set:text={`target-${set.level}`}
                            />

                            <Heading
                                class:list='screen-reader-text'
                                displayHeading={8}
                                heading={heading + 1}
                                set:text='Contrast Test Targets'
                            />

                            <div 
                                class="shade-swatch__contrast"
                                style={[
                                    `--shade-swatch-contrast-result-group-column-count: 2`,
                                    `--shade-swatch-contrast-result-group-row-count: 2`,
                                ].join(';')}
                            >
                                <div
                                    class:list={[
                                        'shade-swatch__contrast__result-group',
                                        'shade-swatch__contrast__result-group--min-max',
                                    ]}
                                    style={`--shade-swatch-contrast-result-group-column-count: 5;`}
                                >
                                    {(['aa', 'aaa'] as const).map( (standard) => (
                                        <div
                                            class:list={ [
                                                'shade-swatch__contrast__result-group__single-min-max',
                                                `shade-swatch__contrast__result-group__single-min-max--minimum`,
                                                `shade-swatch__contrast__result-group__single-min-max--minimum--${standard}`,
                                            ] }
                                            style={`--shade-swatch-contrast-result-group-single-min-max-column-count: ${set.min?.[standard].colCount}`}
                                        >
                                            <Heading
                                                heading={heading + 2}
                                                displayHeading={10}

                                                class:list={[
                                                    'screen-reader-text | ',
                                                    'shade-swatch__contrast__result-group__heading',
                                                    'shade-swatch__contrast__result-group__heading--minimum',
                                                    `shade-swatch__contrast__result-group__heading--minimum--${standard}`,
                                                ]}
                                                set:text={standard.toUpperCase()}
                                            />
                                            {set.min?.[standard].ui && (
                                                <ContrastAlert
                                                    class={[
                                                        'shade-swatch__contrast__result-group__alert',
                                                        'shade-swatch__contrast__result-group__alert--minimum',
                                                        'shade-swatch__contrast__result-group__alert--minimum--ui',
                                                        `shade-swatch__contrast__result-group__alert--minimum--${standard}`,
                                                    ]}
                                                    clr={tokens.colour.base[set.min[standard].ui]}
                                                    clrSlug={`base-${set.min[standard].ui}`}
                                                    level={set.min[standard].ui}
                                                    title={`${standard.toUpperCase()} UI min: ${set.min[standard].ui}`}
                                                    type='ui-minimum'
                                                />
                                            )}
                                            {set.min?.[standard].text && (
                                                <ContrastAlert
                                                    class={[
                                                        'shade-swatch__contrast__result-group__alert',
                                                        'shade-swatch__contrast__result-group__alert--minimum',
                                                        'shade-swatch__contrast__result-group__alert--minimum--text',
                                                        `shade-swatch__contrast__result-group__alert--minimum--${standard}`,
                                                    ]}
                                                    clr={tokens.colour.base[set.min[standard].text]}
                                                    clrSlug={`base-${set.min[standard].text}`}
                                                    level={set.min[standard].text}
                                                    title={`${standard.toUpperCase()} text min: ${set.min[standard].text}`}
                                                    type='minimum'
                                                />
                                            )}
                                        </div>
                                    ) )}

                                    {set.max && (
                                        <div
                                            class:list={[
                                                'shade-swatch__contrast__result-group__single-min-max',
                                                'shade-swatch__contrast__result-group__single-min-max--maximum',
                                            ]}
                                            style={`--shade-swatch-contrast-result-group-single-min-max-column-count: 1`}
                                        >
                                            <Heading 
                                                heading={heading + 2}
                                                displayHeading={10}
                                                class:list={[
                                                    'screen-reader-text | ',
                                                    'shade-swatch__contrast__result-group__heading',
                                                    'shade-swatch__contrast__result-group__heading--maximum',
                                                ]}
                                                set:text='Max'
                                            />
                                            <ContrastAlert
                                                class={[
                                                    'shade-swatch__contrast__result-group__alert',
                                                    'shade-swatch__contrast__result-group__alert--maximum',
                                                ]}
                                                clr={tokens.colour.base[set.max]}
                                                clrSlug={`base-${set.max}`}
                                                level={set.max}
                                                title={`max: ${set.max}`}
                                                type='maximum'
                                            />
                                        </div>
                                    )}
                                </div>

                                { goalLevels.accent?.[level] && (
                                    <div
                                        class:list={[
                                            'shade-swatch__contrast__result-group',
                                            'shade-swatch__contrast__result-group--min-max',
                                        ]}
                                        style={`--shade-swatch-contrast-result-group-column-count: 5;`}
                                    >
                                        { (['aa', 'aaa'] as const).map( (standard) => goalLevels.accent?.[level] && (
                                            <div
                                                class:list={ [
                                                    'shade-swatch__contrast__result-group__single-min-max',
                                                    `shade-swatch__contrast__result-group__single-min-max--minimum`,
                                                    `shade-swatch__contrast__result-group__single-min-max--minimum--${standard}`,
                                                ] }
                                                style={`--shade-swatch-contrast-result-group-single-min-max-column-count: ${goalLevels.accent[level].min?.[standard].colCount}`}
                                            >
                                                <Heading
                                                    heading={heading + 2}
                                                    displayHeading={10}

                                                    class:list={[
                                                        'screen-reader-text | ',
                                                        'shade-swatch__contrast__result-group__heading',
                                                        'shade-swatch__contrast__result-group__heading--minimum',
                                                        `shade-swatch__contrast__result-group__heading--minimum--${standard}`,
                                                    ]}
                                                    set:text={`${standard.toUpperCase()} (accent colours)`}
                                                />
                                                {goalLevels.accent[level].min?.[standard].ui && (
                                                    <ContrastAlert
                                                        class={[
                                                            'shade-swatch__contrast__result-group__alert',
                                                            'shade-swatch__contrast__result-group__alert--minimum',
                                                            'shade-swatch__contrast__result-group__alert--minimum--ui',
                                                            `shade-swatch__contrast__result-group__alert--minimum--${standard}`,
                                                        ]}
                                                        clr={primaryColour[goalLevels.accent[level].min[standard].ui]}
                                                        clrSlug={`accent-${goalLevels.accent[level].min[standard].ui}`}
                                                        level={goalLevels.accent[level].min[standard].ui}
                                                        title={`${standard.toUpperCase()} UI min: ${goalLevels.accent[level].min[standard].ui}`}
                                                        type='ui-minimum'
                                                    />
                                                )}
                                                {goalLevels.accent[level].min?.[standard].text && (
                                                    <ContrastAlert
                                                        class={[
                                                            'shade-swatch__contrast__result-group__alert',
                                                            'shade-swatch__contrast__result-group__alert--minimum',
                                                            'shade-swatch__contrast__result-group__alert--minimum--text',
                                                            `shade-swatch__contrast__result-group__alert--minimum--${standard}`,
                                                        ]}
                                                        clr={primaryColour[goalLevels.accent[level].min[standard].text]}
                                                        clrSlug={`accent-${goalLevels.accent[level].min[standard].text}`}
                                                        level={goalLevels.accent[level].min[standard].text}
                                                        title={`${standard.toUpperCase()} text min: ${goalLevels.accent[level].min[standard].text}`}
                                                        type='minimum'
                                                    />
                                                )}
                                            </div>
                                        ) )}

                                        {goalLevels.accent[level].max && (
                                            <div
                                                class:list={[
                                                    'shade-swatch__contrast__result-group__single-min-max',
                                                    'shade-swatch__contrast__result-group__single-min-max--maximum',
                                                ]}
                                                style={`--shade-swatch-contrast-result-group-single-min-max-column-count: 1`}
                                            >
                                                <Heading 
                                                    heading={heading + 2}
                                                    displayHeading={10}
                                                    class:list={[
                                                        'screen-reader-text | ',
                                                        'shade-swatch__contrast__result-group__heading',
                                                        'shade-swatch__contrast__result-group__heading--maximum',
                                                    ]}
                                                    set:text='Max'
                                                />
                                                <ContrastAlert
                                                    class={[
                                                        'shade-swatch__contrast__result-group__alert',
                                                        'shade-swatch__contrast__result-group__alert--maximum',
                                                    ]}
                                                    clr={primaryColour[goalLevels.accent[level].max]}
                                                    clrSlug={`accent-${goalLevels.accent[level].max}`}
                                                    level={goalLevels.accent[level].max}
                                                    title={`max: ${goalLevels.accent[level].max}`}
                                                    type='maximum'
                                                />
                                            </div>
                                        )}
                                    </div>
                                ) }
                            </div>
                        </article>
                    </th>  ) }</Fragment>
                </tr> }
                {colour.map(({ name, map }) => (
                    <tr>
                        <th
                            class="screen-reader-text"
                            set:text={name}
                        />
                        {map.map(({ level, values }) => !( excludeLevels.includes( level ) ) && <td>
                            <ShadeSwatch 
                                bases={props.colour.base}
                                contrastIsCondensed={true}
                                displayHeading={7}
                                heading={heading}
                                id={id}
                                level={level}
                                name={name} 
                                tokens={tokens}
                                values={{
                                    ...values,
                                    hex: includeFormats.hex ? values.hex : undefined,
                                    hsl: includeFormats.hsl ? values.hsl : undefined,
                                    lch: includeFormats.lch ? values.lch : undefined,
                                    rgb: includeFormats.rgb ? values.rgb : undefined,
                                }}
                            />
                        </td> )}
                    </tr>
                ))}
            </table>
        </div>
    )
}

<style lang="scss">
    @forward '../scss/shade-swatch';
    @forward '../scss/shade-swatch-table';
</style>
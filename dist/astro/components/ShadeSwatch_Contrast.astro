---
/**
 * @since 0.1.0-alpha
 *
 * @packageDocumentation
 */

/* import - types */
import type { ComponentProps } from 'astro/types';
import type { ColourContrastTest } from '../../ts/01-utilities/ColourContrastTest.js';
import { ColourUtilities } from '../../ts/01-utilities/ColourUtilities.js';
import type {
    ColourLevels,
    ColourLevels_Extended,
    ColourNameGeneric,
} from '../../ts/02-tokens/@types.d.ts';
import type { Tokens, Tokens_Internal } from '../../ts/02-tokens/Tokens.js';
import type { Tokens_Colour_ShadeMap_Shade } from '../../ts/02-tokens/Colour/ShadeMap/ShadeMap_Shade.js';

/* import - functions */
import {
    arrayUnique,
    toTitleCase,
} from '@maddimathon/utility-typescript/functions';
import { objectGenerator } from '../../ts/01-utilities/objectGenerator.js';
import { objectMap } from '../../ts/01-utilities/objectMap.js';

/* import - values */

/* import - components */
import ContrastAlert from './ContrastAlert.astro';
import Heading from '@maddimathon/utility-astro/components/Heading';
// import VariableDump from '@maddimathon/utility-astro/components/VariableDump';

/* import - layouts */

/* PROPS ===================================== */

export interface Props<
    T_ColourName extends string = Tokens_Internal.Default_ColourName,
    T_ExtraLevels extends
        ColourLevels_Extended = Tokens_Internal.Default_ExtraColourLevels,
> extends Omit<
    ComponentProps<typeof Heading>,
    'frontmatter' | 'heading' | 'id'
> {
    heading: number | false;
    id: string;

    thisShadeName: string;
    
    tokens: Tokens.JsonReturn<T_ColourName, T_ExtraLevels>;
    values: Tokens_Colour_ShadeMap_Shade.Contrast<ColourNameGeneric<T_ColourName>, T_ExtraLevels, number>;
    
    brightness?: string;
    isCondensed?: boolean;
}

const {
    brightness,
    class: classList,
    heading: headingRaw,
    id,
    isCondensed = false,
    thisShadeName,
    tokens,
    values,
    ...attributes
}: Props = Astro.props;

/* FUNCTIONS ===================================== */

type ColourSet_AllShadeLevels_Result = undefined | {
    [ T in keyof ColourContrastTest.TestResult_Single ]: {
        [ S in "aa" | "aaa" ]: boolean;
    };
};

type ColourSet_AllShadeLevels<
    T_ExtraLevels extends ColourLevels_Extended,
> = undefined | {
    [ K in ColourLevels | T_ExtraLevels ]?: {
        level: ColourLevels | T_ExtraLevels;
        ratio: number;
        result: ColourSet_AllShadeLevels_Result;
        interpretedResult: string;
        type: ComponentProps<typeof ContrastAlert>['type'];
    };
};

type ColourSet_MinMax_Single<
    T_ExtraLevels extends ColourLevels_Extended,
> = undefined | {
    level: ColourLevels | T_ExtraLevels;
    ratio: number;
    shade: ColourUtilities.SingleShade;
    shadeLevelName: string;
};

type ColourSet_Minimum<
    T_ExtraLevels extends ColourLevels_Extended,
> = undefined | {
    [S in 'aa' | 'aaa']?: {
        colCount: number;
        text: ColourSet_MinMax_Single<T_ExtraLevels>;
        ui: ColourSet_MinMax_Single<T_ExtraLevels>;
    };
};

type ColourSet<
    T_ColourName extends string = Tokens_Internal.Default_ColourName,
    T_ExtraLevels extends
        ColourLevels_Extended = Tokens_Internal.Default_ExtraColourLevels,
> =
    | undefined
    | {
        [K in T_ColourName]?: {
            name: T_ColourName;
            colCount: number;
            cssTextColour?: string;
            cssTextGreyColour?: string;
            allShades: ColourSet_AllShadeLevels<T_ExtraLevels>;
            min?: ColourSet_Minimum<T_ExtraLevels>;
            max?: ColourSet_MinMax_Single<T_ExtraLevels>;
        };
    };

function getShadeMapSets<
    T_ColourName extends string = Tokens_Internal.Default_ColourName,
    T_ExtraLevels extends
        ColourLevels_Extended = Tokens_Internal.Default_ExtraColourLevels,
>(
    _tokens: Tokens.JsonReturn<T_ColourName, T_ExtraLevels>,
    _values: Props<ColourNameGeneric<T_ColourName>, T_ExtraLevels>['values'],
    _isCondensed: boolean,
    _thisShadeName: string,
): ColourSet<ColourNameGeneric<T_ColourName>, T_ExtraLevels> {
    const allColours = arrayUnique(
        Object.keys(_values.min ?? []).concat(Object.keys(_values.max ?? []))
    ) as ColourNameGeneric<T_ColourName>[];

    // returns
    if (!allColours.length) {
        return undefined;
    }

    const summarizer = (
        _v:
            | undefined
            | Tokens_Colour_ShadeMap_Shade.Contrast.SingleMinMax<
                ColourNameGeneric<T_ColourName>, 
                T_ExtraLevels, 
                number
            >,
    ): ColourSet_MinMax_Single<T_ExtraLevels> =>
        _v && {
            level: _v.level,
            shade: _tokens.colour[_v.name][_v.level],
            shadeLevelName: `${_v.name}-${_v.level}`,
            ratio: _v.ratio,
        };
        
    type _StdResult = undefined|Tokens_Colour_ShadeMap_Shade.Contrast.SingleMinMax<
            ColourNameGeneric<T_ColourName>, 
            T_ExtraLevels, 
            number
        >;

    const minMaker = <T_Std extends 'aa' | 'aaa'>(
        _clr: ColourNameGeneric<T_ColourName>,
        _std: T_Std,
    ): NonNullable<ColourSet_Minimum<T_ExtraLevels>>[T_Std] => {
        
        const text = summarizer(
            _values.min?.[_clr]?.text?.[_std] as _StdResult
        );

        const ui = summarizer(
            _values.min?.[_clr]?.ui?.[_std] as _StdResult
        );

        if (text || ui) {
            return {
                colCount: text && ui ? 2 : 1,
                text: text || undefined,
                ui: ui || undefined,
            };
        }

        return undefined;
    };

    const base_min_aa = minMaker('base', 'aa');
    const base_min_aaa = minMaker('base', 'aaa');
    const base_max = summarizer(_values.max?.['base'] as _StdResult) || undefined;

    function _generator<T_Clr extends T_ColourName>(
        colourName: ColourNameGeneric<T_Clr>,
    ): {
        name: ColourNameGeneric<T_Clr>;
        colCount: number;
        cssTextColour?: string;
        cssTextGreyColour?: string;
        allShades: ColourSet_AllShadeLevels<T_ExtraLevels>;
        min?: ColourSet_Minimum<T_ExtraLevels>;
        max?: ColourSet_MinMax_Single<T_ExtraLevels>;
    } {

        const min_aa = minMaker(colourName, 'aa');
        const min_aaa = minMaker(colourName, 'aaa');
        
        const min: ColourSet_Minimum<T_ExtraLevels> = ( min_aa || min_aaa ) && {
            aa: min_aa || undefined,
            aaa: min_aaa || undefined,
        };

        const max: ColourSet_MinMax_Single<T_ExtraLevels> = summarizer(_values.max?.[colourName] as _StdResult) || undefined;

        const colCount: number =
            (max ? 1 : 0) + (min?.aa?.colCount ?? 0) + (min?.aaa?.colCount ?? 0);

        const cssTextColourLevel =
            min?.aa?.text?.level ??
            min?.aaa?.text?.level ??
            max?.level;

        const cssTextGreyColourLevel =
            base_min_aa?.text?.level ??
            base_min_aaa?.text?.level ??
            base_max?.level;

        const allShades: ColourSet_AllShadeLevels<T_ExtraLevels> =
            _isCondensed ? undefined : _values.results[ colourName ] && objectMap(
                _values.results[ colourName ],
                
                (res) => {
                    
                    let __val: undefined | {
                        level: ColourLevels | T_ExtraLevels;
                        ratio: number;
                        result: ColourSet_AllShadeLevels_Result;
                        interpretedResult: string;
                        type: ComponentProps<typeof ContrastAlert>['type'];
                    } = undefined;

                    if (res.value?.ratio) {

                        const result = {
                            text: {
                                aa: res.value?.aa?.text,
                                aaa: res.value?.aaa?.text,
                            },
                            ui: {
                                aa: res.value?.aa?.ui,
                                aaa: res.value?.aaa?.ui,
                            },
                        };

                        let interpretedResult: undefined|string = undefined;
                        let type: undefined | ComponentProps<typeof ContrastAlert>['type'] = undefined;

                        if (result.text.aaa) {
                            interpretedResult = (interpretedResult ? interpretedResult + ' + ' : '') + "AAA Pass";
                            type = type ?? 'double-check';
                        } else {

                            if (result.text.aa) {
                                interpretedResult = (interpretedResult ? interpretedResult + ' + ' : '') + "AA Pass";
                                type = type ?? 'check';
                            } 
                            
                            if (result.ui.aaa) {
                                interpretedResult = (interpretedResult ? interpretedResult + ' + ' : '') + "AAA UI Pass";
                                type = type ?? 'ui-check';
                            } else if (result.ui.aa) {
                                interpretedResult = (interpretedResult ? interpretedResult + ' + ' : '') + "AA UI Pass";
                                type = type ?? 'ui';
                            }
                        }

                        __val = {
                            level: res.key as ColourLevels | T_ExtraLevels,
                            ratio: res.value?.ratio,
                            result,
                            interpretedResult: interpretedResult ?? 'Fail',
                            type: type ?? 'fail',
                        };
                    }

                    return __val;
                }
            );

        return {
            name: colourName,
            colCount,

            min,
            max,

            cssTextColour:
                cssTextColourLevel  
                && ColourUtilities.toString.hsl(_tokens.colour[colourName][cssTextColourLevel]),

            cssTextGreyColour:
                cssTextGreyColourLevel 
                && ColourUtilities.toString.hsl(_tokens.colour.base[cssTextGreyColourLevel]),

            allShades,
        };
    };

    // returns
    if (_isCondensed && _thisShadeName !== 'base') {
        return objectGenerator(
            [ 'base' ], 
            _generator
        );
    }

    return objectGenerator(
        allColours, 
        _generator
    );
}

/* CONSTANTS ===================================== */

const heading = headingRaw || 7;

const shadeMapSets = getShadeMapSets(tokens, values, isCondensed, thisShadeName);

const resultGroupColCount = shadeMapSets?.base?.allShades && Math.max(
    Math.ceil( Object.keys( shadeMapSets.base.allShades ).length / 2  ),
    6
);
---

<Heading
    {...attributes}
    class:list={['screen-reader-text', classList]}
    heading={heading}
    set:text='Contrast Test Results'
/>

<div 
    class="shade-swatch__contrast"
    style={[
        `--shade-swatch-contrast-result-group-column-count: ${resultGroupColCount};`,
        `--shade-swatch-contrast-result-group-row-count: 2;`,
    ].join(' ')}
    data-brightness-mode="light"
>
    {
        shadeMapSets &&
            Object.values(shadeMapSets).map((shadeMapSet) => (
                <Heading
                    heading={heading + 1}
                    displayHeading={9}

                    class:list={[
                        isCondensed && 'screen-reader-text',
                        'shade-swatch__contrast__heading',
                    ]}
                    set:text={toTitleCase(shadeMapSet.name)}
                    data-contrast-result-group-has-heading-color={shadeMapSet.cssTextColour && 'true'}
                    style={
                        shadeMapSet.cssTextColour &&
                        `--shade-swatch-contrast-result-group-heading-color: ${shadeMapSet.cssTextColour};`
                    }
                />

                <div
                    class:list={[
                        'shade-swatch__contrast__result-group',
                        'shade-swatch__contrast__result-group--min-max',
                    ]}
                    style={`--shade-swatch-contrast-result-group-column-count: ${shadeMapSet.colCount};`}
                >

                    {(['aa', 'aaa'] as const).map(
                        (standard) =>
                            shadeMapSet.min && shadeMapSet.min?.[standard] && (
                                <div
                                    class:list={[
                                        'shade-swatch__contrast__result-group__single-min-max',
                                        `shade-swatch__contrast__result-group__single-min-max--minimum`,
                                        `shade-swatch__contrast__result-group__single-min-max--minimum--${standard}`,
                                    ]}
                                    style={`--shade-swatch-contrast-result-group-single-min-max-column-count: ${shadeMapSet.min?.[standard].colCount}`}
                                >
                                    <Heading
                                        heading={heading + 2}
                                        displayHeading={10}

                                        class:list={[
                                            isCondensed && 'screen-reader-text | ',
                                            'shade-swatch__contrast__result-group__heading',
                                            'shade-swatch__contrast__result-group__heading--minimum',
                                            `shade-swatch__contrast__result-group__heading--minimum--${standard}`,
                                        ]}
                                        set:text={standard.toUpperCase()}
                                        style={
                                            shadeMapSet.cssTextColour &&
                                            `--shade-swatch-contrast-result-group-heading-color: ${shadeMapSet.cssTextGreyColour};`
                                        }
                                    />
                                    {shadeMapSet.min?.[standard].ui && (
                                        <ContrastAlert
                                            brightness={brightness}
                                            class={[
                                                'shade-swatch__contrast__result-group__alert',
                                                'shade-swatch__contrast__result-group__alert--minimum',
                                                'shade-swatch__contrast__result-group__alert--minimum--ui',
                                                `shade-swatch__contrast__result-group__alert--minimum--${standard}`,
                                            ]}
                                            clr={shadeMapSet.min[standard].ui.shade}
                                            clrSlug={shadeMapSet.min[standard].ui.shadeLevelName}
                                            level={shadeMapSet.min[standard].ui.level}
                                            title={`${standard.toUpperCase()} UI min: ${shadeMapSet.min[standard].ui.shadeLevelName}`}
                                            type='ui-minimum'
                                        />
                                    )}
                                    {shadeMapSet.min?.[standard].text && (
                                        <ContrastAlert
                                            brightness={brightness}
                                            class={[
                                                'shade-swatch__contrast__result-group__alert',
                                                'shade-swatch__contrast__result-group__alert--minimum',
                                                'shade-swatch__contrast__result-group__alert--minimum--text',
                                                `shade-swatch__contrast__result-group__alert--minimum--${standard}`,
                                            ]}
                                            clr={shadeMapSet.min[standard].text.shade}
                                            clrSlug={shadeMapSet.min[standard].text.shadeLevelName}
                                            level={shadeMapSet.min[standard].text.level}
                                            title={`${standard.toUpperCase()} text min: ${shadeMapSet.min[standard].text.shadeLevelName}`}
                                            type='minimum'
                                        />
                                    )}
                                </div>
                            )
                    )}

                    {shadeMapSet.max && (
                        <div
                            class:list={[
                                'shade-swatch__contrast__result-group__single-min-max',
                                'shade-swatch__contrast__result-group__single-min-max--maximum',
                            ]}
                            style={`--shade-swatch-contrast-result-group-single-min-max-column-count: 1`}
                        >
                            <Heading 
                                heading={heading + 2}
                                displayHeading={10}

                                class:list={[
                                    isCondensed && 'screen-reader-text | ',
                                    'shade-swatch__contrast__result-group__heading',
                                    'shade-swatch__contrast__result-group__heading--maximum',
                                ]}
                                set:text='Max'
                            />
                            <ContrastAlert
                                brightness={brightness}
                                class={[
                                    'shade-swatch__contrast__result-group__alert',
                                    'shade-swatch__contrast__result-group__alert--maximum',
                                ]}
                                clr={shadeMapSet.max.shade}
                                clrSlug={shadeMapSet.max.shadeLevelName}
                                level={shadeMapSet.max.level}
                                title={`max: ${shadeMapSet.max.shadeLevelName}`}
                                type='maximum'
                            />
                        </div>
                    )}
                </div>

                <Fragment>
                    { shadeMapSet.allShades && (
                        <div
                            class:list={[
                                'shade-swatch__contrast__result-group',
                                'shade-swatch__contrast__result-group--all-shades',
                            ]}
                        >
                            <Heading 
                                heading={heading + 2}
                                displayHeading={10}

                                class={[
                                    'shade-swatch__contrast__result-group__heading',
                                    'shade-swatch__contrast__result-group__heading--all-shades',
                                    `shade-swatch__contrast__result-group__heading--all-shades--${shadeMapSet.name}`,
                                ]}
                                set:text='All'
                                style={
                                    shadeMapSet.cssTextGreyColour &&
                                    `--shade-swatch-contrast-result-group-heading-color: ${shadeMapSet.cssTextGreyColour};`
                                }
                            />
                            
                            { Object.values( shadeMapSet.allShades ).map( ( singleLevel ) => singleLevel && (
                                <ContrastAlert
                                    brightness={brightness}
                                    class={[
                                        'shade-swatch__contrast__result-group__alert',
                                        'shade-swatch__contrast__result-group__alert--maximum',
                                    ]}
                                    clr={tokens.colour[shadeMapSet.name][singleLevel.level]}
                                    clrSlug={`${shadeMapSet.name}-${singleLevel.level}`}
                                    level={ singleLevel.level }
                                    title={`${shadeMapSet.name}-${singleLevel.level}: ${singleLevel.interpretedResult}` + ( import.meta.env.DEV ? ` (${singleLevel.ratio.toFixed(5)})` : '' )}
                                    type={ singleLevel.type }
                                />
                            ) ) }
                        </div>
                    ) }
                </Fragment>
            ))
    }
</div>


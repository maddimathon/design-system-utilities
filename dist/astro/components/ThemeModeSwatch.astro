---
/**
 * @since 0.1.0-alpha.draft
 *
 * @packageDocumentation
 */

/* import - types */
import type { HTMLAttributes } from 'astro/types';
import type { RecursiveRecord } from '../../ts/01-utilities/@types.d.ts';
import type { ColourLevels } from '../../ts/02-tokens/@types.d.ts';
import type { Tokens } from '../../ts/02-tokens/Tokens.js';
import type { Tokens_Themes_Set_SingleMode } from '../../ts/02-tokens/Themes/Themes_Set_SingleMode.js';

/* import - functions */
import { toTitleCase } from '@maddimathon/utility-typescript/functions';
import { objectGenerator } from '../../ts/01-utilities/objectGenerator.js';
import { objectMap } from '../../ts/01-utilities/objectMap.js';
import { textColorLevel } from './ShadeSwatch.astro';

/* import - values */

/* import - components */
import Heading from '@maddimathon/utility-astro/components/Heading';
import Table from '@maddimathon/utility-astro/components/Table';
import VariableDump from '@maddimathon/utility-astro/components/VariableDump';

/* import - layouts */

/* TYPES ===================================== */

/* PROPS ===================================== */

export interface Props extends Omit<HTMLAttributes<'div'>, 'class'> {
    heading: number;
    theme: Tokens.Themes.SingleMode.JsonReturn;

    brightness?: string;
    contrast?: string;
    
    /**
     * HTML string used between the theme token name and its value.
     */
    equals?: string;
}

const {
    brightness,
    contrast,
    equals = '=',
    heading: _heading,
    theme,
    ...attributes
}: Props = Astro.props;

/* FUNCTIONS ===================================== */

function themeTokenFlatten<T_Val extends string | number |undefined |null|any[]>( 
    prefix: null|string,
    obj:  RecursiveRecord<string, T_Val>,
): { key: string; value: T_Val; }[] {
    const pre = prefix == '$' ? '' : prefix ?? '';

    const mapper = ( { key, value }: { 
        key: string; 
        value: T_Val|RecursiveRecord<string, T_Val>;
    } ): {
        key: string;
        value: T_Val;
    }[] => {
        key = pre + ( key == '$' ? '' : `-${key}` );

        // returns 
        if ( value && typeof value === 'object' && !Array.isArray(value) ) {
            return themeTokenFlatten( key, value );
        }
        
        return [{key: 'theme-' + key, value}];
    };

    return Object.values(
        objectMap(
            obj,
            mapper
        )
    ).flat();
}

/* CONSTANTS ===================================== */

const customDisplayKeys = ['background', 'button', 'field', 'selection', 'system'];

const autoTokens = Object.values(
    objectMap(theme.data, ({ key, value }) =>
        customDisplayKeys.includes(key)
            ? false
            : (typeof value !== 'object' || Array.isArray( value ) )
              ? { key, value }
              : { key, variations: themeTokenFlatten( 
                    key, 
                    value as RecursiveRecord<string, string>
                ) }
    )
).filter((v) => v !== false);

const headingHTML = (await Astro.slots.render('heading')) || false;

const heading = _heading + (headingHTML ? 1 : 0);

const levelsInUse = theme.levelsInUse.map(
    ( levels ) => ( {
        levels,

        styles: objectMap(
            levels,
            ( { value } ) => {

                const textColor = textColorLevel( value as ColourLevels );
                
                return textColor && {
                    background: `var(--clr-base-${value})`,
                    color: `var(--clr-base-${textColor})`,
                } ;
            }
        ),
    } ),
);


type ButtonVariation = {
    name: string;
    states: {
        [ K in keyof Tokens_Themes_Set_SingleMode.Data_Button<string, never>['bg'] ]: {

            [ K in keyof Tokens_Themes_Set_SingleMode.Data_Button<string, never> ]: {
                state: null | Exclude<
                    keyof Tokens_Themes_Set_SingleMode.Data_Button<string, never>['bg'],
                    '$'
                >;
                key: string;
                value: string | string[];
            };
        };
    };
};

const buttons: {
    [ K in 'primary' | 'secondary' | 'disabled' ]: ButtonVariation;
} & {
    [ key: string ]: ButtonVariation;
} = objectMap(
    theme.data.button,
    ( { key: variation, value } ): ButtonVariation => ( {
        name: variation,
        states: objectGenerator(
            [ '$', 'hover', 'active' ],
            ( key ) => {

                const state =  key == '$' ? null : key;

                const keySuffix = key == '$' ? '' : `-${key}`;
                
                return {
                    bg: {
                        state,
                        key: `button-${variation}-bg${keySuffix}`,
                        value: value.bg[key],
                    },
                    border: {
                        state,
                        key: `button-${variation}-border${keySuffix}`,
                        value: value.border[key],
                    },
                    text: {
                        state,
                        key: `button-${variation}-text${keySuffix}`,
                        value: value.text[key],
                    },
                };
            }
        ),
    } ),
);


const field: {
    [ K in keyof Tokens.Themes.SingleMode.JsonReturn['data']['field']['text'] ]: {

        [ K in keyof Tokens.Themes.SingleMode.JsonReturn['data']['field'] ]: {
            state: null | Exclude<
                keyof Tokens.Themes.SingleMode.JsonReturn['data']['field']['text'],
                '$'
            >;
            key: string;
            value: string | string[];
        };
    };
} = objectGenerator(
    [ '$', 'hover', 'active' ],
    ( key ) => {

        const state =  key == '$' ? null : key;

        const keySuffix = key == '$' ? '' : `-${key}`;
        
        return {
            accent: {
                state,
                key: `field-accent${keySuffix}`,
                value: theme.data.field.accent[key],
            },
            bg: {
                state,
                key: `field-bg${keySuffix}`,
                value: theme.data.field.bg[key],
            },
            border: {
                state,
                key: `field-border${keySuffix}`,
                value: theme.data.field.border[key],
            },
            text: {
                state,
                key: `field-text${keySuffix}`,
                value: theme.data.field.text[key],
            },
        };
    }
);

// const cssVars = {
//     'shade-swatch-color': text || undefined,
//     'shade-swatch-background': bg ?? undefined,
// };
---

<article
    class:list={['container', 'theme-mode-swatch']}
    {...attributes}
    data-brightness-mode={brightness}
    data-contrast-mode={contrast}
>
    {
        headingHTML && (
            <Heading
                heading={heading - 1}
                class:list={['theme-mode-swatch__name']}
                set:html={headingHTML}
            />
        )
    }
    { theme.description &&  <p set:html={theme.description} /> }
    <Heading
        heading={heading}
        set:text='Tokens'
    />
    <p
        class="theme-mode-swatch__sample"
    ><code set:text="theme-background" /> {equals} <code set:text={theme.data.background} />.</p>
    <p
        class="theme-mode-swatch__sample theme-mode-swatch__sample--selection"
    ><code set:text='theme-selection-bg' /> {equals} <code set:text={theme.data.selection.bg} /></p>
    <p
        class="theme-mode-swatch__sample theme-mode-swatch__sample--selection"
    ><code set:text='theme-selection-text' /> {equals} <code set:text={theme.data.selection.text} /></p>
    {
        autoTokens.map((tokens) => (
            <Heading
                heading={heading + 1}
                set:text={`${tokens.key == 'ui' ? tokens.key.toUpperCase() : toTitleCase(tokens.key)} Tokens`}
            />
            <Fragment>{ tokens.variations ? tokens.variations.map( ( { key, value } ) => (
                <p
                    class="theme-mode-swatch__sample"
                    style={ [
                        !( value === 'transparent' || value === 'unset' ) && `color: var(--${key}, var(--clr-${value}))`,
                    ].filter( v => v ).join(';') }
                ><code set:text={key} /> {equals} <code set:text={value} /></p>
            ) ) : (
                <VariableDump
                    name='tokens'
                    var={tokens}
                />
            ) }</Fragment>  
        ))
    }
    <Heading
        heading={heading + 1}
        set:text='Buttons'
    />
    { Object.values( buttons ).map( ( variation ) => (
        <Heading
            heading={heading + 2}
            class:list='screen-reader-text'
            set:text={variation.name}
        />
        <div class:list={['button-span | theme-mode-swatch__button-span']}>{ Object.values( variation.states ).map( ( state ) => (
            <a
                href="#"
                set:text={`${toTitleCase(variation.name)} Button${state.bg.state ? ` (${state.bg.state})` : ''}`}
                aria-disabled={ variation.name === 'disabled' ? true : undefined }
                class:list={ [
                    'button',
                    'theme-mode-swatch__sample',
                    'theme-mode-swatch__sample--button',
                ] }
                style={ [
                    `border-color: var(--${state.border.key}, var(--clr-${state.border.value}))`,
                    `background: var(--${state.bg.key}, var(--clr-${state.bg.value}))`,
                    `color: var(--${state.text.key}, var(--clr-${state.text.value}))`,
                ].join(';') }
            />
        ) ) }</div>
    ) ) }
    <Heading
        heading={heading + 1}
        set:text='Input Fields'
    />
    { Object.values( field ).map( ( state ) => (
        <input
            type="text"
            placeholder={`Field${state.bg.state ? ` (${state.bg.state})` : ''}`}
            class:list={ [
                'theme-mode-swatch__sample',
                'theme-mode-swatch__sample--field',
            ] }
            style={ [
                `border-color: var(--theme-${state.border.key}, var(--clr-${state.border.value}))`,
                `background: var(--theme-${state.bg.key}, var(--clr-${state.bg.value}))`,
                `color: var(--theme-${state.text.key}, var(--clr-${state.text.value}))`,
            ].join(';') }
        />
    ) ) }
    { levelsInUse.length && (
        <Heading
            heading={heading}
            set:text='Shades in Use'
        />
        <Table 
            class:list={['theme-mode-swatch__shades-in-use']}
        >
            <tr>
                <th set:text='Light Mode' />
                <th set:text='Dark Mode' />
            </tr>
            { levelsInUse.map( ({ levels, styles }) => <tr>
                <td 
                    data-brightness-mode="light"
                    set:text={levels.light}
                    style={styles && [
                        `background: ${styles.light.background}`,
                        `color: ${styles.light.color}`,
                    ].join(';')}
                />
                <td 
                    data-brightness-mode="light"
                    set:text={levels.dark}
                    style={styles && [
                        `background: ${styles.dark.background}`,
                        `color: ${styles.dark.color}`,
                    ].join(';')}
                />
            </tr> ) }
        </Table>
    ) }
</article>

<style lang='scss'>
    @forward '../scss/theme-mode-swatch';
</style>

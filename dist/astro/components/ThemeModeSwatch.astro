---
/**
 * @since 0.1.0-alpha
 *
 * @packageDocumentation
 */

/* import - types */
import type { HTMLAttributes } from 'astro/types';
import type { RecursiveRecord } from '../../ts/01-utilities/@types.d.ts';
import type { Tokens } from '../../ts/02-tokens/Tokens.js';
import type { Tokens_Themes_Set_SingleMode } from '../../ts/02-tokens/Themes/Themes_Set_SingleMode.js';

/* import - functions */
import { toTitleCase } from '@maddimathon/utility-typescript/functions';
import { ColourUtilities } from '../../ts/01-utilities/ColourUtilities.js';
import { objectGenerator } from '../../ts/01-utilities/objectGenerator.js';
import { objectMap } from '../../ts/01-utilities/objectMap.js';
import { textColorLevel } from './ShadeSwatch.astro';

/* import - values */

/* import - components */
import Heading from '@maddimathon/utility-astro/components/Heading';
import Table from '@maddimathon/utility-astro/components/Table';
import VariableDump from '@maddimathon/utility-astro/components/VariableDump';
import LoremIpsum from './LoremIpsum.astro';

/* import - layouts */

/* TYPES ===================================== */

type _ButtonVariation = {
    name: string;
    states: {
        [ K in keyof Tokens_Themes_Set_SingleMode.Data_Button<string, never>['bg'] ]: {

            [ K in keyof Tokens_Themes_Set_SingleMode.Data_Button<string, never> ]: undefined | {
                state: null | Exclude<
                    keyof Tokens_Themes_Set_SingleMode.Data_Button<string, never>['bg'],
                    '$'
                >;
                key: string;
                value: string | string[] ;
            };
        };
    };
};

type _ParsedInputField = {
    [ InputType in keyof Tokens.Themes.SingleMode.JsonReturn['data']['input'] ]: {
        [ K in keyof Tokens.Themes.SingleMode.JsonReturn['data']['input'][InputType]['text'] ]: {

            [ K in keyof Tokens.Themes.SingleMode.JsonReturn['data']['input'][InputType] ]: {
                state: null | Exclude<
                    keyof Tokens.Themes.SingleMode.JsonReturn['data']['input'][InputType]['text'],
                    '$'
                >;
                variation: "$" | "disabled" | "readonly",
                label: string;
                key: string;
                clrSlug: string | string[];
            };
        };
    };
};

/* PROPS ===================================== */

export interface Props extends Omit<HTMLAttributes<'div'>, 'class'> {
    heading: number;
    theme: Tokens.Themes.SingleMode.JsonReturn;
    tokens: Tokens.JsonReturn;

    displayMode: 'preview' | 'tokens';

    brightness?: string;
    contrast?: string;

    displayHeading?: number;
    
    /**
     * HTML string used between the theme token name and its value.
     */
    equals?: string;
}

const {
    brightness,
    contrast,
    displayHeading = 3,
    displayMode,
    equals = '=',
    heading,
    theme,
    tokens,
    ...attributes
}: Props = Astro.props;

/* FUNCTIONS ===================================== */

function themeTokenFlatten<T_Val extends string | number |undefined |null|any[]>( 
    prefix: null|string,
    obj:  RecursiveRecord<string, T_Val>,
): { key: string; value: T_Val; }[] {
    const pre = prefix == '$' ? '' : prefix ?? '';

    const mapper = ( [ key, value ]: [
        string,
        T_Val|RecursiveRecord<string, T_Val>
    ] ): {
        key: string;
        value: T_Val;
    }[] => {
        key = pre + ( key == '$' ? '' : `-${key}` );

        // returns 
        if ( value && typeof value === 'object' && !Array.isArray(value) ) {
            return themeTokenFlatten( key, value );
        }
        
        return [{key: 'theme-' + key, value}];
    };

    return Object.values(
        objectMap(
            obj,
            mapper
        )
    ).flat();
}

function captureClrDataFromThemeValue( 
    _tokens: Tokens.JsonReturn,
    _brightness?: string,
    _clrSlug: string,
): undefined | {
    name: string;
    level: ColourUtilities.Levels.Required | ColourUtilities.Levels.Optional;
} {
    // returns
    if (_clrSlug === 'transparent' || _clrSlug === 'unset') {
        return undefined;
    }

    const matches = _clrSlug?.match( /^([^\s]+)-(\d{3})$/i ) as null | [ string, string, ColourUtilities.Levels.Required ];

    // returns
    if (!matches) {
        return undefined;
    }

    const level = _brightness == 'dark'
     ? ColourUtilities.Levels.toDark( matches[2] )
     : matches[2];

     return {
        name: matches[1],
        level,
     };
}

function getClrFromThemeValue( 
    _tokens: Tokens.JsonReturn,
    _brightness?: string,
    _clrSlug: string | string[],
): string {

    const slug = Array.isArray(_clrSlug) ? _clrSlug[0] : _clrSlug;

    // returns
    if (!slug) {
        return String(slug);
    }
    
    // returns
    if (slug === 'transparent' || slug === 'unset') {
        return 'inherit';
    }
    
    // returns
    if (slug === 'black' || slug === 'white') {

        if (_brightness === 'dark') {
            return ColourUtilities.toString.hsl(
                _tokens.colour[ slug === 'black' ? 'white' : 'black']
            );
        }
        
        return ColourUtilities.toString.hsl(_tokens.colour[slug]);
    }

    const { name, level } = captureClrDataFromThemeValue(_tokens, _brightness, slug) ?? {};

    // returns
    if (!name || !level) {
        return String(slug);
    }
    
    const clr = _tokens.colour[name as 'base']?.[level];

    // returns
    if (!clr) {
        return String(slug);
    }
    
    return ColourUtilities.toString.hsl(clr);
}

/* CONSTANTS ===================================== */

const customDisplayKeys = [ 'background', 'button', 'input', 'selection', 'system' ];

const autoTokens = Object.values(
    objectMap(theme.data, ([key, value ]) =>
        customDisplayKeys.includes(key)
            ? false
            : (typeof value !== 'object' || Array.isArray( value ) )
              ? { key, value }
              : { key, variations: themeTokenFlatten( 
                    key, 
                    value as RecursiveRecord<string, string>
                ) }
    )
).filter((v) => v !== false);

const headingHTML = (await Astro.slots.render('heading')) || false;


const levelsInUseTable = theme.levelsInUse.map(
    ( levels ) => ( {
        levels,

        styles: objectMap(
            levels,
            ( [ key, value ] ) => {
                key;

                const textColor = textColorLevel( value as ColourUtilities.Levels.Required );
                
                return textColor && {
                    background: tokens.colour.base[value],
                    color: tokens.colour.base[textColor],
                } ;
            }
        ),
    } ),
);


const buttons: {
    [ K in 'primary' | 'secondary' | 'disabled' ]: _ButtonVariation;
} & {
    [ key: string ]: _ButtonVariation;
} = objectMap(
    theme.data.button,
    ( [ variation, value ] ): _ButtonVariation => ( {
        name: variation,
        states: objectGenerator(
            [ '$', 'hover', 'active' ],
            ( key ) => {

                const state =  key == '$' ? null : key;

                const keySuffix = key == '$' ? '' : `-${key}`;
                
                return {
                    bg: {
                        state,
                        key: `button-${variation}-bg${keySuffix}`,
                        value: value.bg[key],
                    },
                    border: {
                        state,
                        key: `button-${variation}-border${keySuffix}`,
                        value: value.border[key],
                    },
                    outline: state && value.outline[key] ? {
                        state,
                        key: `button-${variation}-outline${keySuffix}`,
                        value: value.outline[key],
                    } : undefined,
                    text: {
                        state,
                        key: `button-${variation}-text${keySuffix}`,
                        value: value.text[key],
                    },
                    ui: {
                        state,
                        key: `button-${variation}-ui${keySuffix}`,
                        value: value.text[key],
                    },
                };
            }
        ),
    } ),
);

const inputField: _ParsedInputField = objectGenerator(
    [ '$', 'disabled','readonly' ],
    ( inputType ) => objectGenerator(
        [ '$', 'hover', 'active' ],
        ( key ) => {

            const state =  key == '$' ? null : key;

            const keySuffix = key == '$' ? '' : `-${key}`;

            const keyInputSuffix = inputType == '$' ? '' : `-${key}`;

            const label = `Input Field${inputType !== '$' ? ` (${toTitleCase(inputType)})`: ''}${ state ? ` â€” ${state}` : '' }`;
            
            return {
                accent: {
                    key: `input${keyInputSuffix}-accent${keySuffix}`,
                    state,
                    label,
                    variation: inputType,
                    clrSlug: theme.data.input[inputType].accent[key],
                },
                bg: {
                    key: `input${keyInputSuffix}-bg${keySuffix}`,
                    state,
                    label,
                    variation: inputType,
                    clrSlug: theme.data.input[inputType].bg[key],
                },
                border: {
                    key: `input${keyInputSuffix}-border${keySuffix}`,
                    state,
                    label,
                    variation: inputType,
                    clrSlug: theme.data.input[inputType].border[key],
                },
                text: {
                    key: `input${keyInputSuffix}-text${keySuffix}`,
                    state,
                    label,
                    variation: inputType,
                    clrSlug: theme.data.input[inputType].text[key],
                },
            };
        }
    )
);
---

<article
    class:list={['container', 'theme-mode-swatch']}
    {...attributes}
    data-brightness-mode={brightness}
    data-contrast-mode={contrast}
    style={ [
        `--theme-background: var(--clr-${theme.data.background.$})`,
        `--theme-text: var(--clr-${theme.data.text.$})`,
        `background: var(--clr-${theme.data.background.$})`,
        `color: var(--clr-${theme.data.text.$})`,
    ].join(';') }
>
    {
        headingHTML && (
            <Heading
                heading={heading - 1}
                displayHeading={displayHeading - 1}
                class:list={ [
                    'theme-mode-swatch__name',
                ] }
                set:html={headingHTML}
            />
        )
    }

    { theme.description &&  <p class="theme-mode-swatch__description" set:html={theme.description} /> }
    
    { displayMode == 'tokens' ? <Fragment>
        <Heading
            heading={heading}
            displayHeading={displayHeading}
            set:text='Tokens'
        />
        {Object.entries(theme.data.background).map(([_bgSlug, _bgValue]) => (
            <p
                class="theme-mode-swatch__sample"
                style={ [
                    `background: ${getClrFromThemeValue(tokens, brightness, _bgValue)}`,
                    `color: ${getClrFromThemeValue(tokens, brightness, theme.data.text.$)}`,
                ].join(';') }
            ><code set:text={ _bgSlug === '$' ? 'theme-background': `theme-background-${_bgSlug}` } /> {equals} <code set:text={_bgValue} /></p>
        ))}
        <p
            class="theme-mode-swatch__sample theme-mode-swatch__sample--selection"
        ><code set:text='theme-selection-bg' /> {equals} <code set:text={theme.data.selection.bg} /></p>
        <p
            class="theme-mode-swatch__sample theme-mode-swatch__sample--selection"
        ><code set:text='theme-selection-text' /> {equals} <code set:text={theme.data.selection.text} /></p>
        {
            autoTokens.map((_tokens) => (
                <Heading
                    heading={heading + 1}
                    displayHeading={displayHeading + 1}
                    set:text={`${_tokens.key == 'ui' ? _tokens.key.toUpperCase() : toTitleCase(_tokens.key)} Tokens`}
                />
                <Fragment>{ _tokens.variations ? _tokens.variations.map( ( { key, value } ) => (
                    <p
                        class="theme-mode-swatch__sample"
                        style={ `color: ${getClrFromThemeValue(tokens, brightness, value)}` }
                    ><code set:text={key} /> {equals} <code set:text={value} /></p>
                ) ) : (
                    <VariableDump
                        name='_tokens'
                        var={_tokens}
                    />
                ) }</Fragment>  
            ))
        }
        <Heading
            displayHeading={displayHeading + 1}
            heading={heading + 1}
            set:text='Buttons'
        />
        { import.meta.env.DEV && ( 
            <Fragment>
                <Heading
                    heading={heading + 2}
                    class:list='screen-reader-text'
                    set:text='Button Previews'
                />
                { Object.values( buttons ).map( ( variation ) => (
                    <Heading
                        heading={heading + 3}
                        class:list='screen-reader-text'
                        set:text={variation.name}
                    />
                    <div class:list={['button-span | theme-mode-swatch__button-span']}>{ Object.values( variation.states ).map( ( state ) => (
                        <button
                            set:text={`${toTitleCase(variation.name)} Button${state.bg?.state ? ` (${state.bg.state})` : ''}`}
                            aria-disabled={ variation.name === 'disabled' ? true : undefined }
                            class:list={ [
                                `button-${variation.name}`,
                                '|',
                                'theme-mode-swatch__sample',
                                'theme-mode-swatch__sample--button',
                            ] }
                            style={ [
                                state.border?.value && `border-color: ${getClrFromThemeValue(tokens, brightness, state.border.value)}`,
                                state.bg?.value && `background: ${getClrFromThemeValue(tokens, brightness, state.bg.value)}`,
                                state.text?.value && `color: ${getClrFromThemeValue(tokens, brightness, state.text.value)}`,
                            ].join(';') }
                        />
                    ) ) }</div>
                ) ) }
            </Fragment>
         ) }
        <Heading
            heading={heading + 2}
            class:list='screen-reader-text'
            set:text='Button Token Values'
        />
        { Object.values( buttons ).map( ( variation ) => (
            <Heading
                heading={heading + 3}
                displayHeading={displayHeading + 2}
                set:text={`${toTitleCase(variation.name)} Button`}
            />
            <Fragment>{ Object.values( variation.states ).map(
                ( state ) => (['bg', 'border', 'text', 'ui'] as const).map(
                    (key) => (
                        state[key] && ( key != 'border' || state.border?.value != state.bg?.value ) && <p
                            class="theme-mode-swatch__sample"
                            style={ [
                                key === 'bg' && state.text
                                    ? `background: ${getClrFromThemeValue(tokens, brightness, state.text.value)}`
                                    : (key == 'text' || key == 'ui') && state.bg
                                        ? `background: ${getClrFromThemeValue(tokens, brightness, state.bg.value)}`
                                        : '',
                                `color: ${getClrFromThemeValue(tokens, brightness, state[key].value)}`,
                            ].join(';') }
                        ><code set:text={`theme-button-${variation.name}-${key}${state[key].state ? `-${state[key].state}`: '' }`} /> {equals} <code set:text={state[key].value} /></p>
                    )
                )
             ) }</Fragment>
        ) ) }
        <Heading
            heading={heading + 1}
            displayHeading={displayHeading + 1}
            set:text='Input Fields'
        />
        { Object.entries( inputField ).map( ( [variation, fieldSet] ) => Object.values(fieldSet).map( ( state ) => (
            <label 
                class="screen-reader-text"
                set:text={state.bg.label}
            />
            <input
                aria-disabled={ variation === 'disabled' ? 'true' : undefined }
                class:list={ [
                    'theme-mode-swatch__sample',
                    'theme-mode-swatch__sample--input',
                ] }
                disabled={ variation === 'disabled' ? 'true' : undefined }
                placeholder={ variation === '$' ? state.bg.label : '' }
                readonly={ variation === 'readonly' ? 'true' : undefined }
                style={ [
                    `border-color: ${getClrFromThemeValue(tokens, brightness, state.border.clrSlug)}`,
                    `background: ${getClrFromThemeValue(tokens, brightness, state.bg.clrSlug)}`,
                    `color: ${getClrFromThemeValue(tokens, brightness, state.text.clrSlug)}`,
                ].join(';') }
                type="text"
                value ={ variation === '$' ? undefined : state.bg.label }
            /> 
        ) ) ) }
        <Heading
            heading={heading + 2}
            class:list='screen-reader-text'
            set:text='Input Fields Token Values'
        />
        { Object.entries( inputField ).map( ( [variation, fieldSet] ) => (
            <Heading
                heading={heading + 3}
                displayHeading={displayHeading + 2}
                set:text={`${ variation !== '$' ? `${toTitleCase(variation)} ` : '' }Input Fields`}
            />
            <Fragment>{ Object.values( fieldSet ).map(
                ( state ) => (['accent', 'bg', 'border', 'text'] as const).map(
                    (key) => (
                        state[key] && <p
                            class="theme-mode-swatch__sample"
                            style={ [
                                (key == 'accent' || key == 'text') && state.bg 
                                    ? `background: ${getClrFromThemeValue(tokens, brightness, state.bg.clrSlug)}`
                                    : '',
                                (key == 'bg') && state.text 
                                    ? `background: ${getClrFromThemeValue(tokens, brightness, state.text.clrSlug)}`
                                    : '',
                                `color: ${getClrFromThemeValue(tokens, brightness, state[key].clrSlug)}`,
                            ].join(';') }
                        ><code set:text={`theme-input${ variation !== '$' ? `-${variation}` : '' }-${key}${state[key].state ? `-${state[key].state}`: '' }`} /> {equals} <code set:text={state[key].clrSlug} /></p>
                    )
                )
             ) }</Fragment>
        ) ) }
        <slot name="tokens" />
        { levelsInUseTable.length && ( 
            <Heading
                heading={heading}
                displayHeading={displayHeading }
                set:text='Shades in Use'
            />
            <Table 
                class:list={['theme-mode-swatch__shades-in-use']}
            >
                <tr>
                    <th set:text='Light Mode' />
                    <th set:text='Dark Mode' />
                </tr>
                { levelsInUseTable.map( ({ levels, styles }) => <tr>
                    <td 
                        data-brightness-mode="light"
                        set:text={levels.light}
                        style={styles && [
                            `background: ${styles.light.background && ColourUtilities.toString.hsl( styles.light.background )}`,
                            `color: ${styles.light.color && ColourUtilities.toString.hsl( styles.light.color )}`,
                        ].join(';')}
                    />
                    <td 
                        data-brightness-mode="light"
                        set:text={levels.dark}
                        style={styles && [
                            `background: ${styles.dark.background && ColourUtilities.toString.hsl( styles.dark.background )}`,
                            `color: ${styles.dark.color && ColourUtilities.toString.hsl( styles.dark.color )}`,
                        ].join(';')}
                    />
                </tr> ) }
            </Table>
        ) }
    </Fragment> : (
        <hr />
        <LoremIpsum
            abbreviated={true}
            heading={heading}
            tokens={tokens}
            displayHeading={displayHeading}
            mode={import.meta.env.DEV ? 'fancy': undefined}
        >
            { Object.entries( inputField ).map( ( [variation, fieldSet] ) => (
                <label set:text={fieldSet.$.bg.label} />
                <input
                    aria-disabled={ variation === 'disabled' ? 'true' : undefined }
                    class:list={ [
                        'theme-mode-swatch__sample',
                        'theme-mode-swatch__sample--input',
                    ] }
                    disabled={ variation === 'disabled' ? 'true' : undefined }
                    placeholder={ variation === '$' ? 'This is a placeholder value.' : '' }
                    readonly={ variation === 'readonly' ? 'true' : undefined }
                    slot="four"
                    style={ [
                        `border-color: ${getClrFromThemeValue(tokens, brightness, fieldSet.$.border.clrSlug)}`,
                        `background: ${getClrFromThemeValue(tokens, brightness, fieldSet.$.bg.clrSlug)}`,
                        `color: ${getClrFromThemeValue(tokens, brightness, fieldSet.$.text.clrSlug)}`,
                    ].join(';') }
                    type="text"
                    value ={ variation === '$' ? undefined : `This is a ${variation} input.` }
                /> 
            ) ) }
        </LoremIpsum>
        <slot name="preview" />
    ) }
</article>

<style lang='scss'>
    @forward '../scss/theme-mode-swatch';
</style>

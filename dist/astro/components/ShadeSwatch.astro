---
/**
 * @since 0.1.0-alpha
 *
 * @packageDocumentation
 */

/* import - types */
import type { HTMLAttributes } from 'astro/types';
import type { ColourUtilities } from '../../ts/01-utilities/ColourUtilities.js';
import type { ColourNameGeneric } from '../../ts/02-tokens/@types.d.ts';
import type { Tokens, Tokens_Internal } from '../../ts/02-tokens/Tokens.js';
import type { Tokens_Colour_ShadeMap } from '../../ts/02-tokens/Colour/Colour_ShadeMap.js';
import type { Tokens_Colour_ShadeMap_Shade } from '../../ts/02-tokens/Colour/ShadeMap/ShadeMap_Shade.js';

/* import - functions */
import { objectGenerator } from '../../ts/01-utilities/objectGenerator.js';
import { getColourValue } from '../functions/getColourValue.js';
import { textColorLevel } from '../functions/textColorLevel.js';

/* import - values */

/* import - components */
import Heading from '@maddimathon/utility-astro/components/Heading';
// import VariableDump from '@maddimathon/utility-astro/components/VariableDump';
import ShadeSwatch_Contrast from './ShadeSwatch_Contrast.astro';
import ShadeSwatch_ColourValue from './ShadeSwatch_ColourValue.astro';

/* import - layouts */

/* PROPS ===================================== */

export interface Props<
    T_ColourName extends string = Tokens_Internal.Default_ColourName,
    T_ExtraLevels extends ColourUtilities.Levels.Optional =
        Tokens_Internal.Default_ExtraColourLevels,
> extends Omit<HTMLAttributes<'div'>, 'class'> {
    heading: number;
    id: string;
    level:
        | 'black'
        | 'white'
        | ColourUtilities.Levels.Required
        | Tokens_Internal.Default_ExtraColourLevels;

    name: string | null;

    tokens: Tokens.JsonReturn<T_ColourName, T_ExtraLevels>;
    values: Partial<
        Tokens_Colour_ShadeMap_Shade.JsonReturn<
            ColourNameGeneric<T_ColourName>,
            T_ExtraLevels
        >
    >;

    bases?: Tokens_Colour_ShadeMap.JsonReturn<T_ColourName, T_ExtraLevels> & {
        black: Tokens_Colour_ShadeMap_Shade.JsonReturn<
            T_ColourName,
            T_ExtraLevels
        >;
        white: Tokens_Colour_ShadeMap_Shade.JsonReturn<
            T_ColourName,
            T_ExtraLevels
        >;
    };

    contrast?: boolean;
    contrastIsCondensed?: boolean;

    displayHeading?: number | false;
    headingClass?: string | string[];

    displayValues?: boolean;

    wrapperElement?: 'article' | 'div' | 'li' | 'td' | 'section';

    frontmatter?: Omit<Props, 'frontmatter'>;
}

const {
    bases,
    contrast = true,
    contrastIsCondensed = false,
    displayValues = true,
    heading,
    headingClass = [],
    displayHeading,
    id,
    level,
    name,
    tokens,
    wrapperElement: WrapperElement = 'article',
    values,
    ...attributes
}: Props = Astro.props.frontmatter ?? Astro.props;

/* FUNCTIONS ===================================== */

/* CONSTANTS ===================================== */

const bg = getColourValue(values);

const textLevel =
    values.contrast?.min.base?.text?.aaa?.level ??
    values.contrast?.max.base?.level ??
    textColorLevel(level);

const text = bases?.[textLevel] && getColourValue(bases[textLevel]);

const brightnessMode = Number(textLevel) <= 500 ? 'light' : 'dark';

const cssVars = {
    'shade-swatch-color': text,
    'shade-swatch-background': bg,
};

const existingClrValueTypes = (
    Object.keys(values) as (keyof typeof values)[]
).filter((v) => v !== 'contrast');

const clrValueTypes = objectGenerator(
    existingClrValueTypes,
    (version) =>
        values[version] &&
        ({
            version,
            shade: values,
        } satisfies {
            shade: Partial<ColourUtilities.SingleShade>;
            version: keyof ColourUtilities.SingleShade;
        }),
);
---

<WrapperElement
    class:list={['container', 'shade-swatch']}
    data-brightness-mode={brightnessMode}
    {...attributes}
    data-shade-swatch-has-background={cssVars['shade-swatch-background'] &&
        'true'}
    style={[
        attributes.style,
        ...Object.entries(cssVars).map(([slug, value]) =>
            value ? `--${slug}: ${value}` : '',
        ),
    ].join('; ')}
>
    {
        displayHeading !== false && (
            <Heading
                heading={heading}
                displayHeading={displayHeading}
                class:list={['shade-swatch__name', '||', headingClass]}
                set:text={name ? `${name}-${level}` : level}
            />
        )
    }
    {
        displayValues && (
            <Fragment>
                {clrValueTypes['hex'] && (
                    <ShadeSwatch_ColourValue
                        background={true}
                        {...clrValueTypes['hex']}
                    />
                )}
                {clrValueTypes['hsl'] && (
                    <ShadeSwatch_ColourValue
                        background={true}
                        {...clrValueTypes['hsl']}
                    />
                )}
                {clrValueTypes['rgb'] && (
                    <ShadeSwatch_ColourValue
                        background={true}
                        {...clrValueTypes['rgb']}
                    />
                )}
                {clrValueTypes['lch'] && (
                    <ShadeSwatch_ColourValue
                        background={true}
                        {...clrValueTypes['lch']}
                    />
                )}
            </Fragment>
        )
    }
    {
        contrast && values.contrast && (
            <ShadeSwatch_Contrast
                brightness={brightnessMode}
                id={`${id}--${name}-${level}`}
                isCondensed={contrastIsCondensed}
                heading={heading + 1}
                thisShadeName={name}
                tokens={tokens}
                values={values.contrast}
            />
        )
    }
</WrapperElement>

<style lang='scss'>
    @forward '../scss/shade-swatch';
</style>

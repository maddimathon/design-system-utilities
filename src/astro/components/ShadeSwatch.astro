---
/**
 * @since ___PKG_VERSION___
 *
 * @packageDocumentation
 */

/* import - types */
import type { HTMLAttributes } from 'astro/types';
import type { TokenLevels, TokenLevels_Extended } from '../../ts/02-tokens/@types.d.ts';
import type { Tokens_Internal } from '../../ts/02-tokens/Tokens.js';
import type { Tokens_Colour_ShadeMap } from '../../ts/02-tokens/Colour/Colour_ShadeMap.js';
import type { Tokens_Colour_ShadeMap_Shade } from '../../ts/02-tokens/Colour/ShadeMap/ShadeMap_Shade.js';

/* import - functions */

/* import - values */

/* import - components */
import Heading from '@maddimathon/utility-astro/components/Heading';
import ShadeSwatch_Contrast from './ShadeSwatch_Contrast.astro';

/* import - layouts */

/* TYPES ===================================== */

/* PROPS ===================================== */

export interface Props<
    T_ColourName extends string = Tokens_Internal.Default_ColourName,
    T_ExtraLevels extends TokenLevels_Extended = Tokens_Internal.Default_ExtraColourLevels,
> extends Omit<HTMLAttributes<'div'>, 'class'> {
    id: string;
    name: string;
    level: TokenLevels;

    values: {
        [K in keyof Tokens_Colour_ShadeMap_Shade.JsonReturn<T_ColourName, T_ExtraLevels>]?:
            | Tokens_Colour_ShadeMap_Shade.JsonReturn<T_ColourName, T_ExtraLevels>[K]
            | undefined;
    };

    bases?: Tokens_Colour_ShadeMap.JsonReturn<T_ColourName, T_ExtraLevels>;

    contrast?: boolean;
    contrastIsCondensed?: boolean;

    heading?: number;
    headingClass?: string|string[];

    frontmatter?: Omit<Props, 'frontmatter'>;
}

const { 
    bases,
    contrast = true,
    contrastIsCondensed = false,
    heading = 7,
    headingClass = [],
    id,
    level, 
    name,
    values,
    ...attributes
 }: Props = Astro.props.frontmatter ?? Astro.props;

/* CONSTANTS ===================================== */

function textColorLevel(lvl: typeof level) {

    switch ( lvl ) {
        case '100':
            return '700';

        case '200':
            return '800';

        case '300':
            return '900';

        case '400':
            return '900';

        case '500':
            return '100';

        case '600':
            return '100';

        case '700':
            return '100';

        case '800':
            return '200';

        case '900':
            return '300';
    }
}

/* CONSTANTS ===================================== */

values.hex = values.hex?.replace(/^#/g, '');

const bg = values.hsl ? `hsl( ${ values.hsl.h }, ${ values.hsl.s }%, ${ values.hsl.l }% )` : values.hex ? `#${values.hex}`: null;

const textLevel = values.contrast?.min.base?.text?.aaa?.level
    ?? values.contrast?.min.base?.text?.aa?.level
    ?? values.contrast?.max.base?.level
    ?? textColorLevel(level);

const text = bases && textLevel && bases && textLevel in bases && bases[ textLevel ] 
    && `hsl( ${ bases[ textLevel ].hsl.h }, ${ bases[ textLevel ].hsl.s }%, ${ bases[ textLevel ].hsl.l }% )`;

const brightnessMode = Number(textLevel) >= 500 ? 'light' : 'dark';

const cssVars = {
    'shade-swatch-color': text || undefined,
    'shade-swatch-background': bg ?? undefined,
};
--- 

<article
    class:list={['container', 'shade-swatch']}
    data-brightness-mode={brightnessMode}
    {...attributes}
    data-shade-swatch-has-background={cssVars['shade-swatch-background'] && 'true'}
>
    <Heading
        heading={heading}
        class:list={[
            'shade-swatch__name',
            '||',
            headingClass,
        ]}
        set:text={`${name}-${level}`}
    />
    {
        values.hex && (
            <p
                class:list={['shade-swatch__colour-value', `shade-swatch__colour-value--hex`]}
            >
                #<strong set:text={values.hex} />
            </p>
        )
    }
    {
        values.hsl && (
            <p
                class:list={['shade-swatch__colour-value', `shade-swatch__colour-value--hsl`]}
            >
                <!-- prettier-ignore -->
                hsl(<strong set:text={values.hsl.h} />,{' '}<strong set:text={`${values.hsl.s}%`} />,{' '}<strong set:text={`${values.hsl.l}%`} />)
            </p>
        )
    }
    {
        values.rgb && (
            <p
                class:list={['shade-swatch__colour-value', `shade-swatch__colour-value--rgb`]}
            >
                <!-- prettier-ignore -->
                rgb(<strong set:text={values.rgb.r} />,{' '}<strong set:text={`${values.rgb.g}`} />,{' '}<strong set:text={`${values.rgb.b}`} />)
            </p>
        )
    }
    {
        values.lch && (
            <p
                class:list={['shade-swatch__colour-value', `shade-swatch__colour-value--lch`]}
            >
                <!-- prettier-ignore -->
                lch(<strong set:text={values.lch.l} />{' '}<strong set:text={`${values.lch.c}`} />{' '}<strong set:text={`${values.lch.h}`} />)
            </p>
        )
    }
    {
        contrast && values.contrast && <ShadeSwatch_Contrast 
            id={`${id}--${name}-${level}`}
            isCondensed={contrastIsCondensed}
            heading={ heading + 1 }
            thisShadeName={name}
            values={values.contrast}
        />
    }
</article>

<style lang='scss' define:vars={cssVars}>
    @forward '../scss/shade-swatch';
</style>

  
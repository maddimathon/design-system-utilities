---
/**
 * @since 0.1.0-alpha
 *
 * @packageDocumentation
 */

/* import - types */
import type { Tokens, Tokens_Internal } from '../../ts/02-tokens/Tokens.js';
import type { Tokens_Colour } from '../../ts/02-tokens/Tokens_Colour.js';
import type { Tokens_Colour_ShadeMap } from '../../ts/02-tokens/Colour/Colour_ShadeMap.js';

/* import - functions */
import { arrayUnique } from '@maddimathon/utility-typescript/functions';
import { ColourUtilities } from '../../ts/01-utilities/ColourUtilities.js';
import { objectMap } from '../../ts/01-utilities/objectMap.js';
import { Tokens_Colour_ShadeMap_Shade } from '../../ts/02-tokens/Colour/ShadeMap/ShadeMap_Shade.js';
import { colourToArray } from '../functions/colourToArray.js';
import { textColorLevel } from './ShadeSwatch.astro';
 
/* import - values */
 
/* import - components */
import Heading from '@maddimathon/utility-astro/components/Heading';
import ShadeSwatch from './ShadeSwatch.astro';
import ContrastAlert from './ContrastAlert.astro';

/* import - layouts */

/* PROPS ===================================== */

export interface Props<
    T_ColourName extends string = Tokens_Internal.Default_ColourName,
    T_ExtraLevels extends ColourUtilities.Levels.Optional = Tokens_Internal.Default_ExtraColourLevels,
> {
    colour: Tokens_Colour.JsonReturn<T_ColourName, T_ExtraLevels> & {
        base: Tokens_Colour_ShadeMap.JsonReturn<T_ColourName, T_ExtraLevels> & {
        black: Tokens_Colour_ShadeMap_Shade.JsonReturn<
            T_ColourName,
            T_ExtraLevels
        >;
        white: Tokens_Colour_ShadeMap_Shade.JsonReturn<
            T_ColourName,
            T_ExtraLevels
        >;
    }
    };

    id: string; 
    heading: number;
    tokens: Tokens.JsonReturn;

    excludeLevels?: ( ColourUtilities.Levels.Required | T_ExtraLevels )[];
    
    /**
     * Whether to include the given colour formats by default.
     *
     * @since 0.1.0-alpha.4
     */
    includeColourFormats?: {
        hex?: boolean;
        hsl?: boolean;
        lch?: boolean;
        rgb?: boolean;
    };

    /**
     * Whether to include the contrast targets as column headers.
     *
     * @since 0.1.0-alpha.4
     */
    includeTargetLevels?: boolean;

    targets?: undefined|LevelTargets|{
        base: undefined|LevelTargets;
        accent?: undefined|LevelTargets;
    };

    frontmatter?: Omit<Props<T_ColourName, T_ExtraLevels>, 'frontmatter'>;
};

const {
    excludeLevels = [],
    heading,
    id,
    includeTargetLevels = import.meta.env.DEV,
    includeColourFormats = {},
    targets: _targets,
    tokens,
    ...props
}: Props = Astro.props.frontmatter ?? Astro.props;

/* TYPES ===================================== */

export type LevelTargets = {
    [ L in ColourUtilities.Levels.Required | ColourUtilities.Levels.Optional ]: {
        min: {
            aa: {
                ui: ColourUtilities.Levels.Required | ColourUtilities.Levels.Optional | undefined,
                text: ColourUtilities.Levels.Required | ColourUtilities.Levels.Optional | undefined,
            },
            aaa: {
                ui: ColourUtilities.Levels.Required | ColourUtilities.Levels.Optional | undefined,
                text: ColourUtilities.Levels.Required | ColourUtilities.Levels.Optional | undefined,
            },
        },
        max: ColourUtilities.Levels.Required | ColourUtilities.Levels.Optional | undefined,
    }
};

export const DEFAULT_LEVEL_TARGETS: LevelTargets = {
    '100': {
        min: {
            aa: {
                ui: '500',
                text: '600',
            },
            aaa: {
                ui: '600',
                text: '700',
            },
        },
        max: '900',
    },

    '150': {
        min: {
            aa: {
                ui: '500',
                text: '600',
            },
            aaa: {
                ui: '600',
                text: '700',
            },
        },
        max: '900',
    },

    '200': {
        min: {
            aa: {
                ui: '500',
                text: '600',
            },
            aaa: {
                ui: '600',
                text: '700',
            },
        },
        max: '900',
    },

    '250': {
        min: {
            aa: {
                ui: '600',
                text: '700',
            },
            aaa: {
                ui: '700',
                text: '750',
            },
        },
        max: '900',
    },

    '300': {
        min: {
            aa: {
                ui: '600',
                text: '700',
            },
            aaa: {
                ui: '700',
                text: '800',
            },
        },
        max: '900',
    },

    '350': {
        min: {
            aa: {
                ui: '650',
                text: '750',
            },
            aaa: {
                ui: '750',
                text: '850',
            },
        },
        max: '900',
    },

    '400': {
        min: {
            aa: {
                ui: '700',
                text: '800',
            },
            aaa: {
                ui: '800',
                text: undefined,
            },
        },
        max: '900',
    },

    '450': {
        min: {
            aa: {
                ui: '100',
                text: '850',
            },
            aaa: {
                ui: '850',
                text: undefined,
            },
        },
        max: '900',
    },

    '500': {
        min: {
            aa: {
                ui: '200',
                text: undefined,
            },
            aaa: {
                ui: undefined,
                text: undefined,
            },
        },
        max: '900',
    },

    '550': {
        min: {
            aa: {
                ui: '850',
                text: '150',
            },
            aaa: {
                ui: '150',
                text: undefined,
            },
        },
        max: '100',
    },

    '600': {
        min: {
            aa: {
                ui: '300',
                text: '200',
            },
            aaa: {
                ui: '200',
                text: undefined,
            },
        },
        max: '100',
    },

    '650': {
        min: {
            aa: {
                ui: '350',
                text: '250',
            },
            aaa: {
                ui: '250',
                text: '150',
            },
        },
        max: '100',
    },

    '700': {
        min: {
            aa: {
                ui: '400',
                text: '300',
            },
            aaa: {
                ui: '300',
                text: '200',
            },
        },
        max: '100',
    },

    '750': {
        min: {
            aa: {
                ui: '400',
                text: '300',
            },
            aaa: {
                ui: '300',
                text: '250',
            },
        },
        max: '100',
    },

    '800': {
        min: {
            aa: {
                ui: '500',
                text: '400',
            },
            aaa: {
                ui: '400',
                text: '300',
            },
        },
        max: '100',
    },

    '850': {
        min: {
            aa: {
                ui: '500',
                text: '400',
            },
            aaa: {
                ui: '400',
                text: '300',
            },
        },
        max: '100',
    },

    '900': {
        min: {
            aa: {
                ui: '500',
                text: '400',
            },
            aaa: {
                ui: '400',
                text: '300',
            }, 
        },
        max: '100',
    },
};

/* FUNCTIONS ===================================== */

/* CONSTANTS ===================================== */

const includeFormats = {
    hex: true,
    hsl: import.meta.env.DEV ? true : false,
    lch: import.meta.env.DEV ? true : false,
    rgb: false,
    ...includeColourFormats,
};

const allTokenLevels = arrayUnique(Object.values(tokens.colour).map(
    val => ! ( val instanceof Tokens_Colour_ShadeMap_Shade ) 
        ? [] 
        : Object.keys(val) as (ColourUtilities.Levels.Required | ColourUtilities.Levels.Optional)[]
).flat());

const colour = colourToArray(props);

const primaryColour = tokens.colour[
    Object.keys(tokens.colour).filter( k =>  k.match(/^(base|black|white)(\-|\_|$)/i) === null )[0] as Exclude<keyof typeof tokens.colour, "black"|"white">
] ?? tokens.colour.base;

const targets: {
    base: LevelTargets;
    accent?: undefined|LevelTargets;
} = _targets ? ('base' in _targets ) ? (_targets.base ? _targets as {
    base:  LevelTargets;
    accent?: undefined | LevelTargets;
} : {base: DEFAULT_LEVEL_TARGETS}) : {base: _targets}  : {base: DEFAULT_LEVEL_TARGETS};

const goalLevels = objectMap(
    targets,
    ([version, levelMap]) => {
        version;

        return levelMap && objectMap(
            levelMap,
            ( [
                targetLevel, 
                value,
            ] ): false | {
                level: ColourUtilities.Levels.Required|ColourUtilities.Levels.Optional,
                textLevel: ColourUtilities.Levels.Required|ColourUtilities.Levels.Optional,
                min: {
                    aa: {
                        colCount: number;
                        ui: ColourUtilities.Levels.Required|ColourUtilities.Levels.Optional | undefined,
                        text: ColourUtilities.Levels.Required|ColourUtilities.Levels.Optional | undefined,
                    },
                    aaa: {
                        colCount: number;
                        ui: ColourUtilities.Levels.Required|ColourUtilities.Levels.Optional | undefined,
                        text: ColourUtilities.Levels.Required|ColourUtilities.Levels.Optional | undefined,
                    },
                },
                max: ColourUtilities.Levels.Required|ColourUtilities.Levels.Optional | undefined,
            } => {
                // returns - don't include
                if ( excludeLevels.includes( targetLevel ) || ! allTokenLevels.includes(targetLevel) ) {
                    return false;
                }
                
                return {
                    level: targetLevel,
                    
                    textLevel: value.min.aaa.text
                        ?? value.min.aa.text
                        ?? value.max
                        ?? textColorLevel( targetLevel ),
                    
                    min: objectMap(
                        value.min,
                        ( [ key, minSet ] ) => {
                            key;
                            
                            return {
                                colCount: Object.values( minSet ).filter( v => v).length,
                                ...minSet,
                            };
                        }
                    ),

                    max: value.max,
                };
            }
        )
    }
);

const blackTextLevel = props.colour.base.black.contrast?.min.base?.text?.aaa?.level ?? props.colour.base.black.contrast?.max.base?.level ?? 'white';
const whiteTextLevel = props.colour.base.white.contrast?.min.base?.text?.aaa?.level ?? props.colour.base.white.contrast?.max.base?.level ?? 'black';
---

{
    colour && (
        <label
            class='site-width | shade-swatch-table__display-control__label'
            aria-ignore="true"
        ><input 
            type="checkbox"
            data-shade-swatch-table-display-text-toggle={id}
        /> Display table without text</label>
        
        <section
            class:list={['table-wrapper | site-width | shade-swatch-table__wrapper']}
            id={id}
        >
            <table id={id}>
                { includeTargetLevels && goalLevels.base && Object.values( goalLevels.base ).filter( v => v ).length > 0 && <tr>
                    <th
                        class="screen-reader-text" 
                        set:text='contrast targets'
                    />
                    <th
                        aria-hidden="true"
                        data-brightness-mode='light'
                        style={`background: var(--clr-white, ${ColourUtilities.toString.hsl(props.colour.base.white.hsl)})`}
                    ><article
                        class:list={['container', 'shade-swatch']}
                        data-brightness-mode='light'
                        data-shade-swatch-has-background={true}
                        style={ [ 
                            `--shade-swatch-background: ${ColourUtilities.toString.hsl(props.colour.base.white)}`,
                            `--shade-swatch-color: ${ColourUtilities.toString.hsl(props.colour.base[ whiteTextLevel ])}`,
                        ].join(';') }
                    /></th>
                    <Fragment>{ (
                        Object.entries( goalLevels.base ) as [ColourUtilities.Levels.Required|ColourUtilities.Levels.Optional, typeof goalLevels.base[ColourUtilities.Levels.Required|ColourUtilities.Levels.Optional]][]
                    ).map( ([level, set]) => set && <th> 
                        <article
                            class:list={['container', 'shade-swatch']}
                            data-brightness-mode={ Number(set.level) <= 500 ? 'light' : 'dark' }
                            data-shade-swatch-has-background={true}
                            style={ [ 
                                `--shade-swatch-background: ${ColourUtilities.toString.hsl(props.colour.base[ set.level ])}`,
                                `--shade-swatch-color: ${ColourUtilities.toString.hsl(props.colour.base[ set.textLevel ])}`,
                                ].join(';') }
                        >
                            <Heading
                                class:list='shade-swatch__name' 
                                displayHeading={7}
                                heading={heading}
                                set:text={`target-${set.level}`}
                            />

                            <Heading
                                class:list='screen-reader-text'
                                displayHeading={8}
                                heading={heading + 1}
                                set:text='Contrast Test Targets'
                            />

                            <div 
                                class="shade-swatch__contrast"
                                style={[
                                    `--shade-swatch-contrast-result-group-column-count: 2`,
                                    `--shade-swatch-contrast-result-group-row-count: 2`,
                                ].join(';')}
                            >
                                <div
                                    class:list={[
                                        'shade-swatch__contrast__result-group',
                                        'shade-swatch__contrast__result-group--min-max',
                                    ]}
                                    style={`--shade-swatch-contrast-result-group-column-count: 5;`}
                                >
                                    {(['aa', 'aaa'] as const).map( (standard) => (
                                        <div
                                            class:list={ [
                                                'shade-swatch__contrast__result-group__single-min-max',
                                                `shade-swatch__contrast__result-group__single-min-max--minimum`,
                                                `shade-swatch__contrast__result-group__single-min-max--minimum--${standard}`,
                                            ] }
                                            style={`--shade-swatch-contrast-result-group-single-min-max-column-count: ${set.min?.[standard].colCount}`}
                                        >
                                            <Heading
                                                heading={heading + 2}
                                                displayHeading={10}

                                                class:list={[
                                                    'screen-reader-text | ',
                                                    'shade-swatch__contrast__result-group__heading',
                                                    'shade-swatch__contrast__result-group__heading--minimum',
                                                    `shade-swatch__contrast__result-group__heading--minimum--${standard}`,
                                                ]}
                                                set:text={standard.toUpperCase()}
                                            />
                                            {set.min?.[standard].ui && (
                                                <ContrastAlert
                                                    class={[
                                                        'shade-swatch__contrast__result-group__alert',
                                                        'shade-swatch__contrast__result-group__alert--minimum',
                                                        'shade-swatch__contrast__result-group__alert--minimum--ui',
                                                        `shade-swatch__contrast__result-group__alert--minimum--${standard}`,
                                                    ]}
                                                    clr={tokens.colour.base[set.min[standard].ui]}
                                                    clrSlug={`base-${set.min[standard].ui}`}
                                                    level={set.min[standard].ui}
                                                    title={`${standard.toUpperCase()} UI min: ${set.min[standard].ui}`}
                                                    type='ui-minimum'
                                                />
                                            )}
                                            {set.min?.[standard].text && (
                                                <ContrastAlert
                                                    class={[
                                                        'shade-swatch__contrast__result-group__alert',
                                                        'shade-swatch__contrast__result-group__alert--minimum',
                                                        'shade-swatch__contrast__result-group__alert--minimum--text',
                                                        `shade-swatch__contrast__result-group__alert--minimum--${standard}`,
                                                    ]}
                                                    clr={tokens.colour.base[set.min[standard].text]}
                                                    clrSlug={`base-${set.min[standard].text}`}
                                                    level={set.min[standard].text}
                                                    title={`${standard.toUpperCase()} text min: ${set.min[standard].text}`}
                                                    type='minimum'
                                                />
                                            )}
                                        </div>
                                    ) )}

                                    {set.max && (
                                        <div
                                            class:list={[
                                                'shade-swatch__contrast__result-group__single-min-max',
                                                'shade-swatch__contrast__result-group__single-min-max--maximum',
                                            ]}
                                            style={`--shade-swatch-contrast-result-group-single-min-max-column-count: 1`}
                                        >
                                            <Heading 
                                                heading={heading + 2}
                                                displayHeading={10}
                                                class:list={[
                                                    'screen-reader-text | ',
                                                    'shade-swatch__contrast__result-group__heading',
                                                    'shade-swatch__contrast__result-group__heading--maximum',
                                                ]}
                                                set:text='Max'
                                            />
                                            <ContrastAlert
                                                class={[
                                                    'shade-swatch__contrast__result-group__alert',
                                                    'shade-swatch__contrast__result-group__alert--maximum',
                                                ]}
                                                clr={tokens.colour.base[set.max]}
                                                clrSlug={`base-${set.max}`}
                                                level={set.max}
                                                title={`max: ${set.max}`}
                                                type='maximum'
                                            />
                                        </div>
                                    )}
                                </div>

                                { goalLevels.accent?.[level] && (
                                    <div
                                        class:list={[
                                            'shade-swatch__contrast__result-group',
                                            'shade-swatch__contrast__result-group--min-max',
                                        ]}
                                        style={`--shade-swatch-contrast-result-group-column-count: 5;`}
                                    >
                                        { (['aa', 'aaa'] as const).map( (standard) => goalLevels.accent?.[level] && (
                                            <div
                                                class:list={ [
                                                    'shade-swatch__contrast__result-group__single-min-max',
                                                    `shade-swatch__contrast__result-group__single-min-max--minimum`,
                                                    `shade-swatch__contrast__result-group__single-min-max--minimum--${standard}`,
                                                ] }
                                                style={`--shade-swatch-contrast-result-group-single-min-max-column-count: ${goalLevels.accent[level].min?.[standard].colCount}`}
                                            >
                                                <Heading
                                                    heading={heading + 2}
                                                    displayHeading={10}

                                                    class:list={[
                                                        'screen-reader-text | ',
                                                        'shade-swatch__contrast__result-group__heading',
                                                        'shade-swatch__contrast__result-group__heading--minimum',
                                                        `shade-swatch__contrast__result-group__heading--minimum--${standard}`,
                                                    ]}
                                                    set:text={`${standard.toUpperCase()} (accent colours)`}
                                                />
                                                {goalLevels.accent[level].min?.[standard].ui && (
                                                    <ContrastAlert
                                                        class={[
                                                            'shade-swatch__contrast__result-group__alert',
                                                            'shade-swatch__contrast__result-group__alert--minimum',
                                                            'shade-swatch__contrast__result-group__alert--minimum--ui',
                                                            `shade-swatch__contrast__result-group__alert--minimum--${standard}`,
                                                        ]}
                                                        clr={primaryColour[goalLevels.accent[level].min[standard].ui]}
                                                        clrSlug={`accent-${goalLevels.accent[level].min[standard].ui}`}
                                                        level={goalLevels.accent[level].min[standard].ui}
                                                        title={`${standard.toUpperCase()} UI min: ${goalLevels.accent[level].min[standard].ui}`}
                                                        type='ui-minimum'
                                                    />
                                                )}
                                                {goalLevels.accent[level].min?.[standard].text && (
                                                    <ContrastAlert
                                                        class={[
                                                            'shade-swatch__contrast__result-group__alert',
                                                            'shade-swatch__contrast__result-group__alert--minimum',
                                                            'shade-swatch__contrast__result-group__alert--minimum--text',
                                                            `shade-swatch__contrast__result-group__alert--minimum--${standard}`,
                                                        ]}
                                                        clr={primaryColour[goalLevels.accent[level].min[standard].text]}
                                                        clrSlug={`accent-${goalLevels.accent[level].min[standard].text}`}
                                                        level={goalLevels.accent[level].min[standard].text}
                                                        title={`${standard.toUpperCase()} text min: ${goalLevels.accent[level].min[standard].text}`}
                                                        type='minimum'
                                                    />
                                                )}
                                            </div>
                                        ) )}

                                        {goalLevels.accent[level].max && (
                                            <div
                                                class:list={[
                                                    'shade-swatch__contrast__result-group__single-min-max',
                                                    'shade-swatch__contrast__result-group__single-min-max--maximum',
                                                ]}
                                                style={`--shade-swatch-contrast-result-group-single-min-max-column-count: 1`}
                                            >
                                                <Heading 
                                                    heading={heading + 2}
                                                    displayHeading={10}
                                                    class:list={[
                                                        'screen-reader-text | ',
                                                        'shade-swatch__contrast__result-group__heading',
                                                        'shade-swatch__contrast__result-group__heading--maximum',
                                                    ]}
                                                    set:text='Max'
                                                />
                                                <ContrastAlert
                                                    class={[
                                                        'shade-swatch__contrast__result-group__alert',
                                                        'shade-swatch__contrast__result-group__alert--maximum',
                                                    ]}
                                                    clr={primaryColour[goalLevels.accent[level].max]}
                                                    clrSlug={`accent-${goalLevels.accent[level].max}`}
                                                    level={goalLevels.accent[level].max}
                                                    title={`max: ${goalLevels.accent[level].max}`}
                                                    type='maximum'
                                                />
                                            </div>
                                        )}
                                    </div>
                                ) }
                            </div>
                        </article>
                    </th>  ) }</Fragment>
                    <th 
                        aria-hidden="true"
                        data-brightness-mode='dark'
                        style={`background: var(--clr-white, ${ColourUtilities.toString.hsl(props.colour.base.black.hsl)})`}
                    ><article
                        class:list={['container', 'shade-swatch']}
                        data-brightness-mode='dark'
                        data-shade-swatch-has-background={true}
                        style={ [ 
                            `--shade-swatch-background: ${ColourUtilities.toString.hsl(props.colour.base.black)}`,
                            `--shade-swatch-color: ${ColourUtilities.toString.hsl(props.colour.base[ blackTextLevel ])}`,
                        ].join(';') }
                    /></th>
                </tr> }
                {colour.map(({ name, map }) => (
                    <tr>
                        <th
                            class="screen-reader-text"
                            set:text={name}
                        />
                        <td
                            data-brightness-mode='light'
                            style={`background: var(--clr-white, ${ColourUtilities.toString.hsl(props.colour.base.white.hsl)})`}
                        ><ShadeSwatch 
                            bases={props.colour.base}
                            contrast={false}
                            displayHeading={name === 'base' ? 7 : false}
                            displayValues={name === 'base'}
                            heading={heading}
                            id={id}
                            level='white'
                            name='base' 
                            tokens={tokens}
                            values={ name === 'base' ? {
                                ...props.colour.base.white,
                                hex: includeFormats.hex ? props.colour.base.white.hex : undefined,
                                hsl: includeFormats.hsl ? props.colour.base.white.hsl : undefined,
                                lch: includeFormats.lch ? props.colour.base.white.lch : undefined,
                                rgb: includeFormats.rgb ? props.colour.base.white.rgb : undefined,
                            } : props.colour.base.white }
                        /></td>
                        {map.map(({ level, values }) => !( 
                            excludeLevels.includes( level )
                            || ( level as string ) === 'black'
                            || ( level as string ) === 'white'
                         ) && <td>
                            <ShadeSwatch 
                                bases={props.colour.base}
                                contrastIsCondensed={true}
                                displayHeading={7}
                                heading={heading}
                                id={id}
                                level={level}
                                name={name} 
                                tokens={tokens}
                                values={{
                                    ...values,
                                    hex: includeFormats.hex ? values.hex : undefined,
                                    hsl: includeFormats.hsl ? values.hsl : undefined,
                                    lch: includeFormats.lch ? values.lch : undefined,
                                    rgb: includeFormats.rgb ? values.rgb : undefined,
                                }}
                            />
                        </td> )}
                        <td
                            data-brightness-mode='dark'
                            style={`background: var(--clr-white, ${ColourUtilities.toString.hsl(props.colour.base.black.hsl)})`}
                        ><ShadeSwatch 
                            bases={props.colour.base}
                            contrast={false}
                            displayHeading={name === 'base' ? 7 : false}
                            displayValues={name === 'base'}
                            heading={heading}
                            id={id}
                            level='black'
                            name='base' 
                            tokens={tokens}
                            values={ name === 'base' ? {
                                ...props.colour.base.black,
                                hex: includeFormats.hex ? props.colour.base.black.hex : undefined,
                                hsl: includeFormats.hsl ? props.colour.base.black.hsl : undefined,
                                lch: includeFormats.lch ? props.colour.base.black.lch : undefined,
                                rgb: includeFormats.rgb ? props.colour.base.black.rgb : undefined,
                            } : props.colour.base.black }
                        /></td>
                    </tr>
                ))}
            </table>
        </div>
    )
}

<style lang="scss">
    @forward '../scss/shade-swatch';
    @forward '../scss/shade-swatch-table';
</style>
///
/// @package @maddimathon/design-system-utilities@___CURRENT_VERSION___
/// @since 0.1.0-alpha
///

@use 'pkg:@maddimathon/utility-sass/list';
@use 'pkg:@maddimathon/utility-sass/map';
@use 'pkg:@maddimathon/utility-sass/math';
@use 'pkg:@maddimathon/utility-sass/meta';
@use 'pkg:@maddimathon/utility-sass/selector';

@use '../../../config';
@use '../../../tokens';

@use '../../01-functions' as *;

@use '02-01-03-decoration' as *;

@use 'pkg:@maddimathon/utility-astro/02-mixins' as utils;

@function _font-src-list($list, $isVariable: false) {
    $_list: ();

    $_srcSuffix: if($isVariable, ' tech(variations)', '');

    @each $map in $list {
        $type: map.get($map, type);
        $paths: map.get($map, path);

        @if meta.type-of($paths) != list {
            $paths: ($paths);
        }

        @each $path in $paths {
            $_list: list.append(
                $_list,
                if(
                    $type == local,
                    "local('#{$path}')#{$_srcSuffix}",
                    'url("#{config.$path_fonts}#{$path}") format("#{$type}")#{$_srcSuffix}'
                ),
                $separator: comma
            );
        }
    }

    @return $_list;
}

$_designSystemHasFontFamilies: tokens-has-font-families();

@mixin _tokens-font-face-style-printer($styleMap, $isVariable: false) {
    @each $style, $fileMap in $styleMap {
        @if map.get($fileMap, printFontFace) {
            @font-face {
                //
                @each $prop, $value in $fileMap {
                    //
                    @if $prop == fallbacks or $prop == printFontFace {
                    } @else if $prop == family {
                        font-family: '#{$value}';
                    } @else if $prop == style or $prop == weight {
                        font-#{$prop}: #{$value};
                    } @else if $prop == src {
                        src: #{_font-src-list($value, $isVariable: $isVariable)};
                    } @else {
                        #{$prop}: #{$value};
                    }
                }
            }
        }
    }
}

///
/// Prints out the font face declarations based on tokens.
///
/// @since 0.1.0-alpha
///
@mixin tokens-font-face {
    @if $_designSystemHasFontFamilies {
        /* #region Tokens - Font Face */
        @each $slug, $familyMap in map.get(tokens.$designSystem, font, family) {
            //
            $weightMap: map.get($familyMap, weights);

            $fontMap: map.get(tokens.$designSystem, font, family, $slug, variable);

            @if $fontMap != null {
                @include _tokens-font-face-style-printer($fontMap, $isVariable: true);
            } @else {
                @each $weight, $styleMap in $weightMap {
                    //
                    @include _tokens-font-face-style-printer($styleMap);
                }
            }
        }
        /* #endregion Tokens - Font Face */
    }
}

///
/// Prints out the font face declarations based on tokens.
///
/// @since 0.1.0-alpha
///
@mixin tokens-font-family {
    @if $_designSystemHasFontFamilies {
        /* #region Tokens - Font Families */
        #{selector.parent-or-root()} {
            @each $slug in map.keys(map.get(tokens.$designSystem, font, family)) {
                @include utils.cx-prop(ff-#{$slug}, font-family-list($slug));
            }
        }
        /* #endregion Tokens - Font Families */
    }
}

///
/// Changes varies size-related tokens to the values for the given family.
///
/// @since 0.1.1-alpha.0
///
@mixin font-family-size-tokens($slug) {
    //
    $map: map.get(tokens.$designSystem, font, familyOverrides, $slug);

    @if $map {
        $label: map.get($map, label);

        @if $label == 'Open Dyslexic' {
            @include utils.cx-prop(icon-size--font-multiplier, 1.1875);
            @include utils.cx-prop(icon-size-pseudo--font-multiplier, 1.25);
            @include utils.cx-prop(icon-size-pseudo--inline-buffer-start, 3);
            @include utils.cx-prop(icon-size-pseudo--inline-buffer-end, 1);
        }

        $width_multiplier: map.get($map, contentWidthScale);

        @if $width_multiplier != null {
            // prettier-ignore
            @if meta.type-of($width_multiplier) == number and $width_multiplier != 1 {
                $border_multiplier: -1;

                @if $width_multiplier > 1 {
                    $border_multiplier: $width_multiplier;
                }

                // WIDTHS
                @if $width_multiplier > 0 and $width_multiplier != 1 {
                    @include utils.tokens-width($multiplier: $width_multiplier);
                }

                // BORDER WIDTHS
                @if $border_multiplier > 0 and $border_multiplier != 1 {
                    @include tokens-border-width($multiplier: $border_multiplier);
                }
            }
        }

        $lh_multiplier: map.get($map, lineHeightScale);

        @if $lh_multiplier != null {
            //
            @if meta.type-of($lh_multiplier) == number and $lh_multiplier != 1 {
                $margin_multiplier: -1;
                $stroke_multiplier: -1;

                @if $lh_multiplier > 1 {
                    $margin_multiplier: if(
                        $lh_multiplier < 2,
                        calc((($lh_multiplier - 1) * mrg-value-firm('400')) + 1),
                        $lh_multiplier
                    );

                    $stroke_multiplier: $lh_multiplier;
                }

                // MARGINS
                // prettier-ignore
                @if $margin_multiplier > 0 and ($margin_multiplier < 1 or $margin_multiplier >= 1.0625) {
                    @include utils.tokens-margin($multiplier: $margin_multiplier);
                    @include utils.tokens-gap($multiplier: $margin_multiplier);
                }

                // LINE HEIGHTS
                @include utils.tokens-line-height($multiplier: $lh_multiplier);

                // STROKE RELATIVE
                @if $stroke_multiplier > 0 and $stroke_multiplier != 1 {
                    @include tokens-stroke-relative($multiplier: $stroke_multiplier);
                }
            }
        }
    }
}

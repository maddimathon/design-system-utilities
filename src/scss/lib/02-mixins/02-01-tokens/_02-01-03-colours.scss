///
/// @package @maddimathon/design-system-utilities@___CURRENT_VERSION___
/// @since ___PKG_VERSION___
///

@use 'pkg:@maddimathon/utility-sass/colour';
// @use 'pkg:@maddimathon/utility-sass/list';
@use 'pkg:@maddimathon/utility-sass/map';
// @use 'pkg:@maddimathon/utility-sass/math';
// @use 'pkg:@maddimathon/utility-sass/meta';
@use 'pkg:@maddimathon/utility-sass/selector';
@use 'pkg:@maddimathon/utility-sass/string';

@use '../../utility-sass' as lib;

// @use '../../../config';
@use '../../../tokens';

@use '../../01-functions' as *;

///
/// Prints out the colour custom property tokens based on config.
///
/// @since ___PKG_VERSION___
///
@mixin tokens-colour {
    /* #region Tokens - Colour */
    @each $mode in tokens.$brightnessMode_all {
        @include lib.colour-mode($mode, $includeDefault: true) {
            @each $slug, $map in tokens.$colour {
                @each $level, $clr in $map {
                    --clr-#{$slug}-#{$level}: #{colour.to-hsl(
                            if(
                                $mode == dark,
                                map.get(
                                    $map,
                                    colour.shade-map-reverse-key(
                                        $level,
                                        $map,
                                        $sort: true
                                    )
                                ),
                                $clr
                            ),
                            $round: false
                        )};
                    // /* #{var-clr($slug, $level)} */
                }
            }
        }
    }
    /* #endregion Tokens - Colour */
}

$_flattenedThemes: map.flatten(tokens.$theme);
$_systemColors: lib.get-sys-colours();

///
/// Prints out the line height custom property default values based on config.
///
/// @since ___PKG_VERSION___
///
@mixin tokens-sys-colour($brightness, $contrast) {
    $map: $_systemColors;

    @each $slug, $list in $map {
        // prettier-ignore
        @if $contrast == forced-colors {
            
            @each $value in $list {
                --sys-clr-#{$slug}: #{$value} !important;
            }
        } @else {
            $lookupSlug: if(
                map.has-key(
                    $_flattenedThemes,
                    '#{$contrast}-#{$brightness}-#{$slug}'
                ),
                $slug,
                if(
                    map.has-key(
                        $_flattenedThemes,
                        '#{$contrast}-#{$brightness}-system-#{$slug}'
                    ),
                    'system-#{$slug}',
                    false
                )
            );

            @if $lookupSlug != false {
                $_clrSlug: theme-token-value(
                    $lookupSlug,
                    $brightness,
                    $contrast
                );

                --sys-clr-#{$slug}: #{if(
                        string.index($_clrSlug, '-'),
                        var-clr(
                            string.slice($_clrSlug, 1, -5),
                            string.slice($_clrSlug, -3, -1),
                            $brightness
                        ),
                        $_clrSlug
                    )};
            }
        }
    }
}

///
/// Prints out the theme custom property tokens based on config.
///
/// @since ___PKG_VERSION___
///
@mixin tokens-theme {
    // prettier-ignore
    @include lib.token-mode-each($includeRegions_heading: 'Tokens - Theme - ') using ($brightness, $contrast) {
            // 
            @include tokens-sys-colour(
                $brightness: $brightness,
                $contrast: $contrast,
            );
        //
        @if $contrast != forced-colors {
            //
            @if map.has-key(tokens.$theme, $contrast) {
                //
                @if map.has-key(map.get(tokens.$theme, $contrast), $brightness)
                {
                    $flattened: map.flatten(
                        map.get(tokens.$theme, $contrast, $brightness)
                    );

                    @each $prop, $value in $flattened {
                        @if string.index($prop, 'system-') != 1 {

                            --theme-#{$prop}: #{if(
                                    string.index($value, '-'),
                                    var-clr(
                                        string.slice($value, 1, -5),
                                        string.slice($value, -3, -1),
                                        $brightness
                                    ),
                                    $value
                                )};
                        }
                    }
                }
            }
        }
    }

    /*#region Tokens - Theme - forced-colors contrast */
    @include lib.forced-colors {
        // all colour modes to ensure the right specificity
        @include lib.colour-mode(
            tokens.$brightnessMode_all,
            $includeQuery: false
        ) {
            @include tokens-sys-colour(
                $brightness: tokens.$brightnessMode_default,
                $contrast: forced-colors
            );

            // prettier-ignore
            @each $prop, $value in map.flatten(map.get(tokens.$theme, forced-colors)) {
                --theme-#{$prop}: #{$value} !important;
            }
        }
    }
    /*#endregion contrast forced-colors */
}

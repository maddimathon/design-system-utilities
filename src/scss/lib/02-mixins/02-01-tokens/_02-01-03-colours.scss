///
/// @package @maddimathon/design-system-utilities@___CURRENT_VERSION___
/// @since 0.1.0-alpha
///

@use 'pkg:@maddimathon/utility-sass/colour';
@use 'pkg:@maddimathon/utility-sass/list';
@use 'pkg:@maddimathon/utility-sass/map';
@use 'pkg:@maddimathon/utility-sass/meta';
@use 'pkg:@maddimathon/utility-sass/selector';
@use 'pkg:@maddimathon/utility-sass/string';

@use '../../../config';
@use '../../../tokens';

@use '../../01-functions' as *;

@use 'pkg:@maddimathon/utility-astro/02-mixins' as utils;

$_activeTheme: map.get(tokens.$themes, tokens.$activeTheme);
$_flattenedActiveTheme: map.flatten($_activeTheme);

$_themeSlugs: map.keys(tokens.$themes);
$_themeSelectors: (config.$selector_null);

@if list.length($_themeSlugs) > 1 {
    @each $key in $_themeSlugs {
        $_themeSelectors: list.append(
            $_themeSelectors,
            '%active-theme--#{$key}',
            $separator: comma
        );
    }
}

$_systemColors: get-sys-colours();
$_flattenedSystemColors: map.flatten($_systemColors);

///
/// Prints out the line height custom property default values based on config.
///
/// @since 0.1.0-alpha
///
@mixin tokens-sys-colour(
    $brightness: null,
    $contrast: null,
    $themeSlug: tokens.$activeTheme
) {
    $map: $_systemColors;

    $activeTheme: map.get(tokens.$themes, default);

    @if map.has-key(tokens.$themes, $themeSlug) {
        $activeTheme: map.get(tokens.$themes, $themeSlug);
    } @else {
        @warn "$themeSlug '#{$themeSlug}' was not a key in tokens.$themes";
    }

    $activeTheme_flat: map.flatten($activeTheme);

    @each $slug, $list in $map {
        // prettier-ignore
        @if $contrast == forced-colors {
            
            @each $value in $list {
                --sys-clr-#{$slug}: #{$value} !important;
            }
            
        } @else if
            $brightness !=
            null and
            $contrast !=
            null
        {
            $lookupSlug: if(
                map.has-key(
                    $activeTheme_flat,
                    '#{$brightness}-#{$contrast}-#{$slug}'
                ),
                $slug,
                if(
                    map.has-key(
                        $activeTheme_flat,
                        '#{$brightness}-#{$contrast}-system-#{$slug}'
                    ),
                    'system-#{$slug}',
                    if(
                        map.has-key($_flattenedSystemColors, '#{$slug}'),
                        '#{$slug}',
                        false
                    )
                )
            );

            @if $lookupSlug != false {
                $_clrSlug: theme-token-value(
                    $lookupSlug,
                    $brightness: $brightness,
                    $contrast: $contrast
                );

                --sys-clr-#{$slug}: #{var-clr-from-theme-token(
                        $_clrSlug,
                        $brightness: $brightness
                    )};
            } @else if map.has-key($_flattenedSystemColors, '#{$slug}') {
                @each $_sysclr in map.get($_systemColors, $slug) {
                    --sys-clr-#{$slug}: #{$_sysclr};
                }
            }
        }
    }
}

///
/// Prints out the colour custom property tokens based on config.
///
/// @since 0.1.0-alpha
///
@mixin tokens-colour {
    /* #region Tokens - Colour */
    @each $mode in tokens.$brightnessMode_all {
        @include utils.colour-mode($mode, $includeDefault: true) {
            @each $slug, $map in tokens.$colour {
                @each $level, $clr in $map {
                    --clr-#{$slug}-#{$level}: #{colour.to-hsl(
                            if(
                                $mode == dark,
                                map.get(
                                    $map,
                                    colour.shade-map-reverse-key(
                                        $level,
                                        $map,
                                        $sort: true
                                    )
                                ),
                                $clr
                            ),
                            $round: false
                        )};
                }
            }
        }
    }
    /* #endregion Tokens - Colour */
}

@mixin _theme-where-defaults($flattenedThemeMap) {
    :where(&) {
        --icon-color: #{var-clr-from-theme-token(
                map.get($flattenedThemeMap, ui)
            )};
    }
}

@mixin tokens-theme-individual(
    $slug,
    $brightness,
    $contrast,
    $activeTheme: tokens.$activeTheme
) {
    $activeTheme: map.get(tokens.$themes, default);

    @if map.has-key(tokens.$themes, $slug) {
        $activeTheme: map.get(tokens.$themes, $slug);
    } @else {
        @warn "$slug '#{$slug}' was not a key in tokens.$themes";
        $slug: default;
    }

    @if $contrast == forced-colors {
        $flattened: map.flatten(map.get($activeTheme, forced-colors));

        @include tokens-sys-colour(
            $brightness: tokens.$brightnessMode_default,
            $contrast: $contrast,
            $themeSlug: $slug
        );

        @each $prop, $value in $flattened {
            @if string.index($prop, 'system-') != 1 {
                --theme-#{$prop}: #{var-clr-from-theme-token(
                        $value
                    )} !important;
            }
        }
    } @else {
        //
        @if map.has-key($activeTheme, $brightness) {
            //
            @if map.has-key(map.get($activeTheme, $brightness), $contrast) {
                $flattened: map.flatten(
                    map.get($activeTheme, $brightness, $contrast)
                );

                @include tokens-sys-colour(
                    $brightness: $brightness,
                    $contrast: $contrast,
                    $themeSlug: $slug
                );

                @each $prop, $value in $flattened {
                    @if string.index($prop, 'system-') != 1 {
                        --theme-#{$prop}: #{var-clr-from-theme-token(
                                $value,
                                $brightness: $brightness
                            )};
                    }
                }
            }
        }
    }
}

$_themes_includeAlternatives: list.length(map.keys(tokens.$themes)) > 1 and
    config.$print_docs;

@mixin tokens-theme-alternatives() {
    @each $key, $_theme in tokens.$themes {
        @include utils.colour-mode-each(
                $includeForcedColors: false,
                $includeRegions_heading: 'Tokens - Theme Override - #{$key} - ',

                // $ignoreParentSelector: true,
                // $includeDefault: false,
                $nestModeSelectors: config.$mx_themeTokens_nestModeSelectors,

                // $nestParentSelector: true,
                // $unifyParentSelector: config.$mx_themeTokens_unifyActiveThemeSelectors,
                 // $wrapParentSelector: false,
            )
            using ($brightness, $contrast) {
            //
            $_sels: (selector.nest(&, '[data-active-theme=#{$key}]'));

            @if config.$mx_themeTokens_nestActiveThemeSelectors {
                //
                $_sels: list.append(
                    $_sels,
                    (
                        selector.nest(
                            config.$selector_root,
                            #{selector.nest(&, '[data-active-theme=#{$key}]')}
                        )
                    ),
                    $separator: comma
                );
            }

            @if config.$mx_themeTokens_unifyActiveThemeSelectors {
                //
                $_sels: list.append(
                    $_sels,
                    (
                        selector.unify(
                            config.$selector_root,
                            '[data-active-theme=#{$key}]'
                        ),
                        selector.nest(
                            config.$selector_root,
                            #{selector.unify(&, '[data-active-theme=#{$key}]')}
                        )
                    ),
                    $separator: comma
                );
            }

            @at-root #{$_sels} {
                @include tokens-theme-individual(
                    $key,
                    $brightness: $brightness,
                    $contrast: $contrast
                );
                @content ($brightness, $contrast);
            }
        }

        // [data-active-theme=#{$key}] {
        //     @include utils.colour-mode-each(
        //         // $includeForcedColors: false,
        //         $includeRegions_heading: 'Tokens - Theme Override - #{$key} - ',

        //         $nestModeSelectors: config.$mx_themeTokens_nestModeSelectors,

        //         $nestParentSelector: true,
        //         $unifyParentSelector: config.$mx_themeTokens_unifyActiveThemeSelectors,
        //         $wrapParentSelector: false,

        //     ) using ($brightness, $contrast) {
        //         @include tokens-theme-individual(
        //             $key,
        //             $brightness: $brightness,
        //             $contrast: $contrast
        //         );
        //         @content($brightness, $contrast);
        //     }
        // }
    }
}

///
/// Prints out the theme custom property tokens based on config.
///
/// @since 0.1.0-alpha
///
@mixin tokens-theme($includeAlternatives: $_themes_includeAlternatives) {
    // prettier-ignore
    @include utils.colour-mode-each(
        $includeRegions_heading: 'Tokens - Theme - ',
        $nestModeSelectors: config.$mx_themeTokens_nestModeSelectors
    ) using ($brightness, $contrast) {
        //
        @include tokens-theme-individual(
            tokens.$activeTheme,
            $brightness: $brightness,
            $contrast: $contrast
        );
        @content($brightness, $contrast);
    }

    // for high-contrast modes
    /* #region Tokens - Theme - Exceptions - high-contrast modes */
    @include utils.colour-mode((high, max, forced-colors)) {
        --focus-ring-outline-width: clamp(
            #{border-width-value('200')},
            #{stroke-relative-value('600')},
            #{border-width-value('400')}
        );
    }
    /* #endregion Tokens - Theme - Exceptions - high-contrast modes */

    @if $includeAlternatives {
        @include tokens-theme-alternatives;
    }
}

///
/// @package @maddimathon/design-system-utilities@___CURRENT_VERSION___
/// @since 0.1.0-alpha
///

@use 'pkg:@maddimathon/utility-sass/colour';
@use 'pkg:@maddimathon/utility-sass/list';
@use 'pkg:@maddimathon/utility-sass/map';
@use 'pkg:@maddimathon/utility-sass/meta';
@use 'pkg:@maddimathon/utility-sass/selector';
@use 'pkg:@maddimathon/utility-sass/string';

@use '../../../config';
@use '../../../tokens';

@use '../../01-functions' as *;

@use 'pkg:@maddimathon/utility-astro/02-mixins' as utils;

$_systemColors: get-sys-colours();
$_flattenedSystemColors: map.flatten($_systemColors);

///
/// Prints out the line height custom property default values based on config.
///
/// @since 0.1.0-alpha
///
@mixin tokens-sys-colour($brightness: null, $contrast: null, $themeSlug: tokens.$activeTheme) {
    $map: $_systemColors;

    $activeTheme_flat: map.get(tokens.$themes__nestedFlat, $themeSlug);

    @if $activeTheme_flat == null {
        @warn "$themeSlug '#{$themeSlug}' was not a key in tokens.$themes__nestedFlat";
    } @else {
        @each $slug, $list in $map {
            // prettier-ignore
            @if $contrast == forced-colors {
                
                @each $value in list.unique($list) {
                    @include utils.cx-prop( sys-clr-#{$slug}, #{$value} !important );
                }
                
            } @else if
                $brightness !=
                null and
                $contrast !=
                null
            {
                $clrSlug: map.get($activeTheme_flat, $brightness, $contrast, $slug);

                @if $clrSlug == null {
                    $clrSlug: map.get($activeTheme_flat, $brightness, $contrast, 'system-#{$slug}');
                }

                @if $clrSlug != null {
                    //
                    @each $_slug in list.unique($clrSlug) {
                        @include utils.cx-prop(
                            sys-clr-#{$slug},
                            var-clr-from-theme-token($_slug, $brightness: $brightness),
                            $comment: if(config.$fn_var_replaceWithValue_colour, $_slug, null)
                        );
                    }
                } @else {
                    $list: map.get($_systemColors, $slug);

                    @if $list != null {
                        $i: 1;

                        @each $value in list.unique($list) {
                            @if $i > 1 {
                                @supports (color: #{$value}) {
                                    @include cx-prop(sys-clr-#{$slug}, $value);
                                }
                            } @else {
                                @include cx-prop(sys-clr-#{$slug}, $value);
                            }

                            $i: $i + 1;
                        }
                    }
                }
            }
        }
    }
}

///
/// Prints out the colour custom property tokens based on config.
///
/// @since 0.1.0-alpha
///
@mixin tokens-colour {
    /* #region Tokens - Colour */
    @each $mode in tokens.$brightnessMode_all {
        @include utils.colour-mode($mode, $includeDefault: true) {
            @each $slug, $map in tokens.$colour {
                @each $level, $clr in map.ksort($map) {
                    $_clrValue: if(
                        $mode == dark,
                        map.get($map, colour.shade-map-reverse-key($level, $map, $sort: true)),
                        $clr
                    );

                    @include utils.cx-prop(
                        clr-#{$slug}-#{$level},
                        colour.to-hsl($_clrValue, $round: false)
                    );
                }

                @if config.$print_colourValues_hsl {
                    @each $level, $clr in map.ksort($map) {
                        $_clrValue: if(
                            $mode == dark,
                            map.get($map, colour.shade-map-reverse-key($level, $map, $sort: true)),
                            $clr
                        );

                        @include utils.cx-prop(
                            clr-#{$slug}-#{$level}-hsl,
                            colour.to-hsl-list($_clrValue, $round: false)
                        );
                    }
                }

                @if config.$print_colourValues_rgb {
                    @each $level, $clr in map.ksort($map) {
                        $_clrValue: if(
                            $mode == dark,
                            map.get($map, colour.shade-map-reverse-key($level, $map, $sort: true)),
                            $clr
                        );

                        @include utils.cx-prop(
                            clr-#{$slug}-#{$level}-rgb,
                            colour.to-rgb-list($_clrValue, $round: true)
                        );
                    }
                }
            }
        }
    }
    /* #endregion Tokens - Colour */
}

///
/// Prints a single theme's properties.
///
/// @since 0.1.0-alpha.5
/// @since 0.1.0-alpha.9 — Made public.
/// @since 0.1.1-alpha.0 — Allowed $slug, $brightness, and $contrast to be optional.
///
@mixin tokens-theme-individual-base-properties(
    $slug: tokens.$activeTheme,
    $brightness: tokens.$brightnessMode_default,
    $contrast: null
) {
    $useSystemColorFallback: false;

    @if $contrast == null {
        $useSystemColorFallback: true;
        $contrast: tokens.$contrastMode_default;
    }

    @include utils.cx-prop(
        focus-ring-outline-color,
        var-theme(
            link-outline,
            $brightness: $brightness,
            $contrast: $contrast,
            $themeSlug: $slug,
            $useSystemColorFallback: $useSystemColorFallback
        )
    );
    @include utils.cx-prop(
        icon-color,
        var-theme(
            ui,
            $brightness: $brightness,
            $contrast: $contrast,
            $themeSlug: $slug,
            $useSystemColorFallback: $useSystemColorFallback
        )
    );
    background: #{var-theme(
            background,
            $brightness: $brightness,
            $contrast: $contrast,
            $themeSlug: $slug,
            $useSystemColorFallback: $useSystemColorFallback
        )};
    color: #{var-theme(
            text,
            $brightness: $brightness,
            $contrast: $contrast,
            $themeSlug: $slug,
            $useSystemColorFallback: $useSystemColorFallback
        )};
}

///
/// Prints a single theme's properties.
///
/// @since 0.1.0-alpha.5
///
@mixin tokens-theme-individual($slug, $brightness, $contrast) {
    $activeTheme_flat: map.get(tokens.$themes__nestedFlat, $slug);

    @if $activeTheme_flat == null {
        @warn "$slug '#{$slug}' was not a key in tokens.$themes__nestedFlat";
        $slug: default;
        $activeTheme_flat: map.get(tokens.$themes__nestedFlat, default);
    }

    @if $contrast == forced-colors {
        $flattened: map.get($activeTheme_flat, forced-colors);

        @include tokens-sys-colour(
            $brightness: tokens.$brightnessMode_default,
            $contrast: $contrast,
            $themeSlug: $slug
        );

        @each $prop, $value in $flattened {
            //
            @each $_val in $value {
                @if string.index($prop, 'system-') != 1 {
                    @include utils.cx-prop(
                        theme-#{$prop},
                        #{var-clr-from-theme-token($_val)} !important
                    );
                }
            }
        }
    } @else {
        //
        $flattened: map.get($activeTheme_flat, $brightness, $contrast);

        @if $flattened != null {
            @include tokens-sys-colour(
                $brightness: $brightness,
                $contrast: $contrast,
                $themeSlug: $slug
            );

            @each $prop, $value in $flattened {
                @if string.index($prop, 'system-') != 1 {
                    //
                    @each $_val in $value {
                        @include utils.cx-prop(
                            theme-#{$prop},
                            var-clr-from-theme-token($_val, $brightness: $brightness),
                            $comment: if(config.$fn_var_replaceWithValue_colour, $_val, null)
                        );
                    }

                    @if config.$print_colourValues_hsl {
                        @each $_val in $value {
                            @include utils.cx-prop(
                                theme-#{$prop}-hsl,
                                #{var-clr-from-theme-token(
                                        $_val,
                                        $brightness: $brightness,
                                        $version: hsl
                                    )}
                            );
                        }
                    }

                    @if config.$print_colourValues_rgb {
                        @each $_val in $value {
                            @include utils.cx-prop(
                                theme-#{$prop}-rgb,
                                #{var-clr-from-theme-token(
                                        $_val,
                                        $brightness: $brightness,
                                        $version: rgb
                                    )}
                            );
                        }
                    }
                }
            }
        }
    }

    @if config.$mx_tokensTheme_setBaseProperties {
        @include tokens-theme-individual-base-properties(
            $slug: $slug,
            $brightness: $brightness,
            $contrast: $contrast
        );
    }
}

$_themes_includeAlternatives: if(
    config.$mx_tokensTheme_includeAlternateThemes == null,
    config.$include_html and list.length(map.keys(tokens.$themes)) > 1,
    config.$mx_tokensTheme_includeAlternateThemes
);

///
/// Handles iterating through each colour mode.
///
/// @since 0.1.0-alpha.4
///
@mixin tokens-theme-iterator(
    $includeAlternatives: $_themes_includeAlternatives,
    $separateQueriesAndSelectors: config.$mx_tokensTheme_separateQueriesAndSelectors
) {
    @if $separateQueriesAndSelectors {
        // prettier-ignore
        @include utils.colour-mode-each(
            $includeRegions_heading: 'Tokens - Theme - Queries - ',
    
            $includeDefault: not config.$include_defaultMediaQueries,
            $includeForcedColors: false,
            $includeQuery: true,
            $includeSelectors: false
        ) using ($brightness, $contrast) {
            @content($brightness, $contrast);
        }

        // prettier-ignore
        @include utils.colour-mode-each(
            $includeRegions_heading: 'Tokens - Theme - Selectors - ',
    
            $includeDefault: config.$mx_tokensTheme_includeDefaultSelectors,
            $includeQuery: false
        ) using ($brightness, $contrast) {
            @content($brightness, $contrast);
        }
    } @else {
        // prettier-ignore
        @include utils.colour-mode-each(
            $includeRegions_heading: 'Tokens - Theme - ',
        ) using ($brightness, $contrast) {
            @content($brightness, $contrast);
        }
    }
}

///
/// Prints out the theme custom property tokens based on config.
///
/// @since 0.1.0-alpha
///
@mixin tokens-theme(
    $includeAlternatives: $_themes_includeAlternatives,
    $separateQueriesAndSelectors: config.$mx_tokensTheme_separateQueriesAndSelectors
) {
    // prettier-ignore
    @include tokens-theme-iterator(
        $includeAlternatives: $includeAlternatives,
        $separateQueriesAndSelectors: $separateQueriesAndSelectors,
    ) using ($brightness, $contrast) {
        //
        @if not $includeAlternatives or $contrast == forced-colors {
            //
            @include tokens-theme-individual(
                tokens.$activeTheme,
                $brightness: $brightness,
                $contrast: $contrast
            );
            @content ($brightness, $contrast, $location: main);
            //
        } @else {
            //
            // defaults first
            @if config.$mx_colourModeEach_nestModeSelectors and
                #{&} !=
                #{config.$selector_root} and
                #{&} !=
                #{config.$selector_body} and
                #{&} !=
                '%root' and
                #{&} !=
                '%body'
            {
                @if config.$mx_tokensTheme_unifyActiveThemeSelectors {
                    &,
                    &[data-active-theme='#{tokens.$activeTheme}'][data-active-theme],
                    & [data-active-theme='#{tokens.$activeTheme}'],
                    %active-theme-selector--#{tokens.$activeTheme} {
                        //
                        @include tokens-theme-individual(
                            tokens.$activeTheme,
                            $brightness: $brightness,
                            $contrast: $contrast
                        );
                        @content ($brightness, $contrast, $location: main);
                    }
                } @else {
                    &,
                    & [data-active-theme='#{tokens.$activeTheme}'],
                    %active-theme-selector--#{tokens.$activeTheme} {
                        //
                        @include tokens-theme-individual(
                            tokens.$activeTheme,
                            $brightness: $brightness,
                            $contrast: $contrast
                        );
                        @content ($brightness, $contrast, $location: main);
                    }
                }
            } @else {
                @if config.$mx_tokensTheme_unifyActiveThemeSelectors {
                    &,
                    &[data-active-theme='#{tokens.$activeTheme}'][data-active-theme],
                    %active-theme-selector--#{tokens.$activeTheme} {
                        //
                        @include tokens-theme-individual(
                            tokens.$activeTheme,
                            $brightness: $brightness,
                            $contrast: $contrast
                        );
                        @content ($brightness, $contrast, $location: main);
                    }
                } @else {
                    &,
                    %active-theme-selector--#{tokens.$activeTheme} {
                        //
                        @include tokens-theme-individual(
                            tokens.$activeTheme,
                            $brightness: $brightness,
                            $contrast: $contrast
                        );
                        @content ($brightness, $contrast, $location: main);
                    }
                }
            }
    
            @each $key in map.keys(tokens.$themes) {
                @if #{$key} != #{tokens.$activeTheme} {
                    //
                    @if config.$mx_colourModeEach_nestModeSelectors {
                        @if config.$mx_tokensTheme_unifyActiveThemeSelectors {
                            &[data-active-theme='#{$key}'][data-active-theme],
                            & [data-active-theme='#{$key}'],
                            [data-active-theme='#{$key}'] &,
                            %active-theme-selector--#{$key} {
                                @include tokens-theme-individual(
                                    $key,
                                    $brightness: $brightness,
                                    $contrast: $contrast
                                );
                                @content ($brightness, $contrast, $location: theme-#{$key});
                            }
                        } @else {
                            & [data-active-theme='#{$key}'],
                            [data-active-theme='#{$key}'] &,
                            %active-theme-selector--#{$key} {
                                @include tokens-theme-individual(
                                    $key,
                                    $brightness: $brightness,
                                    $contrast: $contrast
                                );
                                @content ($brightness, $contrast, $location: theme-#{$key});
                            }
                        }
                    } @else {
                        @if config.$mx_tokensTheme_unifyActiveThemeSelectors {
                            &[data-active-theme='#{$key}'][data-active-theme],
                            & [data-active-theme='#{$key}'],
                            %active-theme-selector--#{$key} {
                                @include tokens-theme-individual(
                                    $key,
                                    $brightness: $brightness,
                                    $contrast: $contrast
                                );
                                @content ($brightness, $contrast, $location: theme-#{$key});
                            }
                        } @else {
                            [data-active-theme='#{$key}'],
                            %active-theme-selector--#{$key} {
                                @include tokens-theme-individual(
                                    $key,
                                    $brightness: $brightness,
                                    $contrast: $contrast
                                );
                                @content ($brightness, $contrast, $location: theme-#{$key});
                            }
                        }
                    }
                }
            }
        }
    }

    // for high-contrast modes
    /* #region Tokens - Theme - Exceptions - high-contrast modes */
    @include utils.colour-mode((high, max, forced-colors)) {
        @include utils.cx-prop(
            focus-ring-outline-width,
            clamp(
                border-width-value('200'),
                stroke-relative-value('600'),
                border-width-value('400')
            )
        );
    }
    /* #endregion Tokens - Theme - Exceptions - high-contrast modes */
}

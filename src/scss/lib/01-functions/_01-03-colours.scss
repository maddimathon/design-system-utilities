///
/// @package @maddimathon/design-system-utilities@___CURRENT_VERSION___
/// @since 0.1.0-alpha
///

@use 'pkg:@maddimathon/utility-sass/colour';
@use 'pkg:@maddimathon/utility-sass/list';
@use 'pkg:@maddimathon/utility-sass/map';
@use 'pkg:@maddimathon/utility-sass/meta';
@use 'pkg:@maddimathon/utility-sass/string';

@use '../../config';
@use '../../tokens';

@use 'pkg:@maddimathon/utility-astro/01-functions' as utils;

$_activeTheme: map.get(tokens.$themes, tokens.$activeTheme);

$_systemColors: map.merge(
    $defaults: utils.get-sys-colours(),
    $inputs: map.get($_activeTheme, forced-colors, system),
    $recursive: true,
);

$_systemColors: map.flatten(
    map.set($_systemColors, background, map.get($_systemColors, background, '$'))
);

///
/// @since 0.1.0-alpha
///
@function get-sys-colours() {
    @return $_systemColors;
}

///
/// Returns the appropriate var (with fallback).
///
/// @param {string} $slug  Colour name.
/// @param {string} $level  Shade level.
/// @param {string} $brightness  Optional. Brightness mode for this value (switched in dark mode).
/// @param {string} $version  Optional. Brightness mode for this value (switched in dark mode). Which list version of the var to fetch, if applicable. Options: null, 'hsl', 'rgb'.
///
/// @since 0.1.0-alpha
/// @since __PKG_VERSION___ — Added $version param.
///
@function var-clr($slug, $level, $brightness: tokens.$brightnessMode_default, $version: null) {
    @if $slug == 'white' or $slug == white or $slug == 'black' or $slug == black {
        $level: null;

        $slug: if(
            $brightness == dark,
            if(
                $slug == 'white' or $slug == white,
                'black',
                if($slug == 'black' or $slug == black, 'white', $slug)
            ),
            if(
                $slug == 'white' or $slug == white,
                'white',
                if($slug == 'black' or $slug == black, 'black', $slug)
            )
        );
    }

    $clrVarSlug: 'clr-#{$slug}';

    @if $level {
        $clrVarSlug: '#{$clrVarSlug}-#{$level}';
    }

    @if $version == 'hsl' {
        @if config.$print_colourValues_hsl {
            $clrVarSlug: '#{$clrVarSlug}-hsl';
        } @else {
            $version: null;
        }
    }

    @if $version == 'rgb' {
        @if config.$print_colourValues_hsl {
            $clrVarSlug: '#{$clrVarSlug}-rgb';
        } @else {
            $version: null;
        }
    }

    $slugMap: map.get(tokens.$colour, $slug);

    // returns
    @if $slugMap == null {
        @warn "$slug '#{$slug}' was not a key in tokens.$colour";
        @return utils.do-var($clrVarSlug);
    }

    $_slugMapType: meta.type-of($slugMap);

    // returns
    @if $_slugMapType != 'map' and $_slugMapType != 'color' {
        @warn "$level '#{$level}' was not a key in tokens.$colour.#{$slug}";
        @return utils.do-var($clrVarSlug);
    }

    $fallback_clr: null;

    @if $_slugMapType == 'color' {
        $fallback_clr: $slugMap;
    } @else {
        $level_brightnessAdjusted: $level;

        @if $brightness == dark {
            $level_brightnessAdjusted: colour.shade-map-reverse-key($level, $slugMap, $sort: true);
        }

        $fallback_clr: map.get($slugMap, $level_brightnessAdjusted);

        // returns
        @if $fallback_clr == null {
            @warn "$level '#{$level}' was not a key in tokens.$colour.#{$slug}";
            @return utils.do-var($clrVarSlug);
        }
    }

    $fallback: $fallback_clr;

    @if $version == 'hsl' {
        $fallback: colour.to-hsl-list($fallback_clr, $round: false);
    } @else if $version == 'rgb' {
        $fallback: colour.to-rgb-list($fallback_clr, $round: true);
    } @else {
        $fallback: colour.to-hsl($fallback_clr, $round: false);
    }

    @return if(
        config.$fn_var_replaceWithValue_colour,
        $fallback,
        utils.do-var($clrVarSlug, $fallback)
    );
}

/// THEME
/// ======================================================================== ///

$_default_activeTheme_mode: if(
    tokens.$contrastMode_default == forced-colors,
    map.get(tokens.$themes, default, tokens.$contrastMode_default),
    map.get(tokens.$themes, default, tokens.$brightnessMode_default, tokens.$contrastMode_default)
);

$_default_activeTheme_flat_mode: if(
    tokens.$contrastMode_default == forced-colors,
    map.get(tokens.$themes__nestedFlat, default, tokens.$contrastMode_default),
    map.get(
        tokens.$themes__nestedFlat,
        default,
        tokens.$brightnessMode_default,
        tokens.$contrastMode_default
    )
);

///
/// Gets a flattened theme map for the given brightness/contrast, if any.
///
/// @return {string|false}
///
/// @since 0.1.1-alpha.0
///
@function get-active-theme(
    $brightness: tokens.$brightnessMode_default,
    $contrast: tokens.$contrastMode_default
) {
    // returns
    @if $brightness == null ad $brightness == null {
        @return $_default_activeTheme_mode;
    }

    $activeTheme_flat: map.get(tokens.$themes, default);

    // returns
    @if $contrast == forced-colors {
        @return map.get(tokens.$themes, default, $contrast);
    }

    @return map.get(tokens.$themes, default, $brightness, $contrast);
}

///
/// Gets a flattened theme map for the given brightness/contrast, if any.
///
/// @return {string|false}
///
/// @since 0.1.1-alpha.0
///
@function get-active-theme-flat(
    $brightness: tokens.$brightnessMode_default,
    $contrast: tokens.$contrastMode_default
) {
    // returns
    @if $brightness == null ad $brightness == null {
        @return $_default_activeTheme_flat_mode;
    }

    $activeTheme_flat: map.get(tokens.$themes__nestedFlat, default);

    // returns
    @if $contrast == forced-colors {
        @return map.get(tokens.$themes__nestedFlat, default, $contrast);
    }

    @return map.get(tokens.$themes__nestedFlat, default, $brightness, $contrast);
}

///
/// Checks whether the given slug is a tokens key. If yes, it returns the
/// flattened value; if no, it returns false.
///
/// @return {string|false}
///
/// @since 0.1.1-alpha.0
///
@function theme-token-exists(
    $slug,
    $brightness: tokens.$brightnessMode_default,
    $contrast: tokens.$contrastMode_default,
    $themeSlug: tokens.$activeTheme,
    $warnOnFalse: false
) {
    $activeTheme_flat: map.get(tokens.$themes__nestedFlat, $themeSlug);

    @if $activeTheme_flat == null {
        @if $warnOnFalse {
            @warn "$themeSlug '#{$themeSlug}' was not a key in tokens.$themes__nestedFlat";
        }

        $themeSlug: default;
        $activeTheme_flat: map.get(tokens.$themes__nestedFlat, $themeSlug);
    }

    // returns
    @if $contrast == forced-colors {
        $value: map.get($activeTheme_flat, $contrast, $slug);

        @if $value == null {
            @if $warnOnFalse {
                @warn "$slug '#{$slug}' was not a key in tokens.$themes__nestedFlat.#{$themeSlug}.#{$contrast}";
            }
            @return false;
        }

        @return $value;
    }

    $value: map.get($activeTheme_flat, $brightness, $contrast, $slug);

    // returns - no fallback
    @if $value == null {
        @if $warnOnFalse {
            @warn "$slug '#{$slug}' was not a key in tokens.$themes__nestedFlat.#{$themeSlug}.#{$brightness}.#{$contrast}";
        }
        @return false;
    }

    @return $value;
}

///
/// Gets the value for the given token slug.
///
/// @since 0.1.0-alpha
/// @since 0.1.1-alpha.0 — Make $brightness and $contrast optional.
///
@function theme-token-value(
    $slug,
    $brightness: tokens.$brightnessMode_default,
    $contrast: tokens.$contrastMode_default,
    $themeSlug: tokens.$activeTheme
) {
    $value: theme-token-exists(
        $slug: $slug,
        $brightness: $brightness,
        $contrast: $contrast,
        $themeSlug: $themeSlug,
        $warnOnFalse: true,
    );

    // returns
    @if $value == null {
        @return ();
    }

    @return $value;
}

///
/// Gets the colour value (either system or var-clr) for the given token slug.
///
/// @since 0.1.0-alpha
///
@function var-clr-from-theme-token(
    $tokenValue,
    $brightness: tokens.$brightnessMode_default,
    $version: null
) {
    $tokenValue: #{$tokenValue};

    // returns
    @if $tokenValue ==
        'white' or
        $tokenValue ==
        white or
        $tokenValue ==
        'black' or
        $tokenValue ==
        black
    {
        @return var-clr($tokenValue, null, $brightness: $brightness, $version: $version);
    }

    // returns
    @if string.length($tokenValue) > 0 and string.index($tokenValue, '-') {
        @return var-clr(
            string.slice($tokenValue, 1, -5),
            string.slice($tokenValue, -3, -1),
            $brightness: $brightness,
            $version: $version
        );
    }

    @return $tokenValue;
}

///
/// Returns the appropriate var (with fallback).
///
/// @since 0.1.0-alpha
/// @since __PKG_VERSION___ — Added $opacity param.
///
@function var-theme(
    $slug,
    $brightness: tokens.$brightnessMode_default,
    $contrast: null,
    $themeSlug: tokens.$activeTheme,
    $useSystemColorFallback: null,
    $opacity: null
) {
    $clrIsSystemColor: false;

    $clrSlug: null;

    @if $useSystemColorFallback == null {
        $useSystemColorFallback: if($contrast == null and $opacity == null, true, false);
    }

    $useSystemColorFallback: $useSystemColorFallback or $contrast == forced-colors;

    @if $contrast == null {
        $contrast: tokens.$contrastMode_default;
    }

    @if $useSystemColorFallback {
        $clrSlug: theme-token-value(
            $slug,
            $brightness: $brightness,
            $contrast: forced-colors,
            $themeSlug: $themeSlug
        );
    }

    @if not $clrSlug {
        $clrSlug: theme-token-value(
            $slug,
            $brightness: $brightness,
            $contrast: $contrast,
            $themeSlug: $themeSlug
        );
    } @else if $useSystemColorFallback {
        $clrIsSystemColor: true;
    }

    // returns
    @if list.length($clrSlug) < 1 {
        @return utils.do-var(theme-#{$slug});
    }

    $opacity: if($opacity != null and not $clrIsSystemColor, $opacity, null);

    @if $clrIsSystemColor {
        $opacity: null;
    } @else if not config.$print_colourValues_hsl and not config.$print_colourValues_rgb {
        $opacity: null;
    }

    @if list.length($clrSlug) > 1 {
        $clrSlug: list.nth($clrSlug, 1);
    }

    // returns
    @if $contrast == forced-colors {
        @return $clrSlug;
    }

    // returns on success
    @if $opacity != null {
        //
        @if config.$print_colourValues_hsl {
            @return hsla(
                #{utils.do-var(
                        theme-#{$slug}-hsl,
                        #{var-clr-from-theme-token(
                                $clrSlug,
                                $brightness: $brightness,
                                $version: hsl
                            )}
                    )},
                #{$opacity}
            );
        } @else if config.$print_colourValues_rgb {
            @return rgba(
                #{utils.do-var(
                        theme-#{$slug}-rgb,
                        #{var-clr-from-theme-token(
                                $clrSlug,
                                $brightness: $brightness,
                                $version: rgb
                            )}
                    )},
                #{$opacity}
            );
        }
    }

    @return utils.do-var(
        theme-#{$slug},
        #{var-clr-from-theme-token($clrSlug, $brightness: $brightness)}
    );
}

///
/// @package @maddimathon/design-system-utilities@___CURRENT_VERSION___
/// @since 0.1.0-alpha
///

@use 'pkg:@maddimathon/utility-sass/feature-check';
@use 'pkg:@maddimathon/utility-sass/list';
@use 'pkg:@maddimathon/utility-sass/selector';

@use '../01-functions' as *;
@use '../02-mixins' as *;

@use 'pkg:@maddimathon/utility-astro/03-snippets' as utils;

$_closing_time: var-tr-time(toggle-closing);

$_defaultHeadingSelectors: list.join(selector-all-headings(), ('%title'));

$_defaultHeadingSelectors_bigOnly: ('%title');

$_defaultHeadingSelectors_greaterThan6: ();

@each $level in token-all-heading-levels() {
    @if $level < 7 {
        $_defaultHeadingSelectors_bigOnly: list.append(
            $_defaultHeadingSelectors_bigOnly,
            ('%h#{$level}')
        );
    }
    @if $level > 6 {
        $_defaultHeadingSelectors_greaterThan6: list.append(
            $_defaultHeadingSelectors_greaterThan6,
            ('%h#{$level}')
        );
    }
}

@mixin _motion-props($bool) {
    [data-toggle-content] {
        $_transitionList: (
            'border-color #{var-tr-time(normal)} ease-in-out 0ms'
        );

        @if $bool {
            $_transitionList: list.join(
                $_transitionList,
                (
                    'grid-template-rows #{$_closing_time} ease-in-out 0ms',
                    'border-block-end-width #{$_closing_time} ease-in-out 0ms'
                ),
                $separator: comma
            );
        } @else {
            $_transitionList: list.join(
                $_transitionList,
                ('grid-template-rows 0ms ease-in-out #{$_closing_time}'),
                $separator: comma
            );
        }

        transition:
            #{$_transitionList},
            #{transition-properties-value(false)};

        > .container {
            $_transitionList: (
                'opacity #{if($bool, $_closing_time, var-tr-time(normal))} ease-in-out 100ms'
            );

            @if $bool {
                $_transitionList: list.join(
                    $_transitionList,
                    ('padding #{$_closing_time} ease-in-out 0ms'),
                    $separator: comma
                );
            }

            transition: #{$_transitionList};
        }
    }

    [data-toggle-container='open'],
    [data-toggle-container='closing'] {
        [data-toggle-control] {
            .toggle-icon {
                > svg #a,
                > svg #b {
                    @if $bool {
                        transition: transform #{$_closing_time} ease-in-out 0ms;
                    } @else {
                        transition: none;
                    }
                }
            }
        }

        > [data-toggle-content] {
            $_transitionList: (
                'border-color #{if($bool, $_closing_time, var-tr-time(normal))} ease-in-out 0ms'
            );

            @if $bool {
                $_transitionList: list.join(
                    $_transitionList,
                    (
                        'grid-template-rows #{$_closing_time} ease-in-out 0ms',
                        'border-block-end-width #{$_closing_time} ease-in-out 0ms'
                    ),
                    $separator: comma
                );
            }

            transition:
                #{$_transitionList},
                #{transition-properties-value(false)};

            > .container {
                @if $bool {
                    transition-delay: 0ms;
                } @else {
                    transition-delay: 0ms, 0ms;
                }
            }
        }
    }
}

///
/// Supports the Toggle astro component.
///
/// @since 0.1.0-alpha
///
@mixin snippet-support-astro-toggle(
    $headingSelectors: $_defaultHeadingSelectors,
    $headingSelectors_bigOnly: $_defaultHeadingSelectors_bigOnly
) {
    @include utils.snippet-support-astro-toggle(
        $headingSelectors: $headingSelectors,
        $headingSelectors_bigOnly: $headingSelectors_bigOnly
    );

    $headingSelectors_whereUnstyled: ();

    @each $sel in list.except($headingSelectors, '%unstyled-heading') {
        $headingSelectors_whereUnstyled: list.append(
            $headingSelectors_whereUnstyled,
            (selector.nest($sel, '&:where( %unstyled-heading )')),
            $separator: comma
        );
    }

    /* Overrides ==================================== */

    [data-toggle-container] {
        @include cx-prop(toggle-closing-time, $_closing_time);
    }

    @include feature-check.js {
        .toggle-title {
            &,
            & > %unstyled-heading,
            & #{selector.nest( '>', #{$headingSelectors_whereUnstyled} )} {
                font-size: #{var-fs(heading-6)};
            }
        }

        .toggle-title,
        [data-toggle-content] {
            transition: #{transition-properties-value(false)};

            [data-toggle-control] {
                color: inherit;
            }
        }

        [data-toggle-container='open'],
        [data-toggle-container='closing'] {
            > [data-toggle-content] {
                border-inline-width: #{var-border-width('300')};
            }
        }

        [data-toggle-container='open'] {
            > [data-toggle-content] {
                border-block-end-width: #{var-border-width('300')};
                border-color: #{var-theme(ui-grey)};
            }
        }

        @include motion($nestParent: false, $unifyParent: true) {
            @include _motion-props(true);
        }

        @include no-motion($nestParent: false, $unifyParent: true) {
            @include _motion-props(false);
        }
    }

    .toggle-title {
        @each $level in token-all-heading-levels() {
            &:has(> %h#{$level}) {
                color: #{var-theme(heading-#{$level})};
            }
        }

        #{selector.nest( '>', ( $headingSelectors ) )} {
            color: inherit;
        }

        [data-toggle-container='open'] & {
            color: #{var-theme(link-hover)};

            + [data-toggle-content] {
                border-color: #{var-theme(ui-grey)};
                border-block-start-color: #{var-theme(link-hover)};
            }
        }

        &,
        [data-toggle-container='open'] & {
            @include hover-focus-visible {
                color: #{var-theme(link)};

                + [data-toggle-content] {
                    border-color: #{var-theme(link)};
                }
            }
        }

        [data-toggle-container='open'] & {
            #{selector.nest( '>', ( $headingSelectors ) )} {
                color: inherit;
            }
        }
    }
}
